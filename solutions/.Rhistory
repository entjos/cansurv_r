## @knitr 7.b
survRate(Surv(surv_mm, death_cancer) ~ year8594, data=melanoma.l)
## @knitr 7.c.i
## Calculate the incidence rate by time of diagnosis
## but with new variables
melanoma.l2 <- mutate(melanoma.l,
## Update the death indicator (only count deaths within 120 months)
## death_cancer = death_cancer * as.numeric(surv_mm<=120),
death_cancer = ifelse(surv_mm<=120 & status == "Dead: cancer",1,0),
## Create a new time variable
## surv_mm = pmin(surv_mm, 120)
surv_mm = ifelse(surv_mm<=120, surv_mm, 120)
)
## Calculate the rates on the truncated data
rates_by_diag_yr2 <- survRate(Surv(surv_mm, death_cancer) ~ year8594, data=melanoma.l2)
rates_by_diag_yr2
## @knitr 7.c.ii
## MRR full data
rates_by_diag_yr2[2, "rate"] / rates_by_diag_yr2[1, "rate"]
with(rates_by_diag_yr2[2:1,], poisson.test(event, tstop))
## @knitr 7.c.iii
## Use glm to estimate the rate ratios
## we scale the offset term to 1000 person-years
poisson7c <- glm( death_cancer ~ year8594 + offset( log( surv_mm/12/1000 ) ), family=poisson, data=melanoma.l2 )
summary( poisson7c )
## also for collapsed data
summary(glm( event ~ year8594 + offset( log( tstop/12/1000 ) ), family=poisson, data=rates_by_diag_yr2))
## IRR
eform(poisson7c)
## Note that the scaling of the offset term only has an impact on the intercept
summary( glm( death_cancer ~ year8594 + offset( log( surv_mm ) ),
family=poisson, data=melanoma.l2 ) )
## @knitr 7.d
## Add a new variable for year
melanoma.l2 <- mutate( melanoma.l2, surv_yy1 = surv_mm/12)
## Split follow up by year
melanoma.spl <- survSplit(melanoma.l2, cut=0:9, end="surv_yy1", start="start",
event="death_cancer")
## Calculate persontime and
## recode start time as a factor
melanoma.spl <- mutate(melanoma.spl,
pt = surv_yy1 - start,
fu = as.factor(start) )
## @knitr 7.e
## Calculate the incidence rate by observation year
yearly_rates <- survRate(Surv(pt/1000,death_cancer)~fu, data=melanoma.spl)
## Plot by year
with(yearly_rates, matplot(fu,
cbind(rate, lower,
upper),
lty=c("solid","dashed","dashed"),
col=c("black","gray","gray"),
type="l",
main="Cancer deaths by years since diagnosis",
ylab="Incidence rate per 1000 person-years",
xlab="Years since diagnosis") )
source('~/cansurv_r/solutions/q111.R', echo=TRUE)
View(yearly_rates)
with(yearly_rates, matplot(fu,
cbind(rate, lower, upper),
lty=c("dashed","dashed","dashed"),
col=c("black","gray","gray"),
type="l",
main="Cancer deaths by years since diagnosis",
ylab="Hazard rate per 1000 person-years",
xlab="Years since diagnosis") )
# Plot
with(yearly_rates, matplot(fu,
cbind(rate, lower, upper),
col=c("black","gray","gray"),
type="l",
main="Cancer deaths by years since diagnosis",
ylab="Hazard rate per 1000 person-years",
xlab="Years since diagnosis") )
# Plot
with(yearly_rates, matplot(fu,
cbind(rate, lower, upper),
col=c("black","gray","gray"),
type="l",
main="Cancer deaths by years since diagnosis",
ylab="Hazard rate per 1000 person-years",
xlab="Years since diagnosis") )
with(yearly_rates, matplot(fu,
cbind(rate, lower, upper),
lty=c("solid","dashed","dashed"),
col=c("black","gray","gray"),
main="Cancer deaths by years since diagnosis",
ylab="Hazard rate per 1000 person-years",
xlab="Years since diagnosis") )
# Plot
with(yearly_rates, matplot(fu,
cbind(rate, lower, upper),
lty=c("solid","dashed","dashed"),
col=c("black","gray","gray"),
type="l",
main="Cancer deaths by years since diagnosis",
ylab="Hazard rate per 1000 person-years",
View(yearly_rates)
View(yearly_rates)
View(yearly_rates)
# Plot
with(yearly_rates, matplot(fu,
cbind(rate, lower, upper),
lty=c("solid","dashed","dashed"),
col=c("black","gray","gray"),
type="l",
main="Cancer deaths by years since diagnosis",
ylab="Hazard rate per 1000 person-years",
# Plot
with(yearly_rates, matplot(fu,
cbind(rate, lower, upper),
lty=c("solid","dashed","dashed"),
col=c("black","gray","gray"),
type="l",
main="Cancer deaths by years since diagnosis",
ylab="Hazard rate per 1000 person-years",
xlab="Years since diagnosis") )
with(yearly_rates, matplot(fu,
cbind(rate, lower, upper),
ylim=c(0,max(upper)),
lty=c("solid","dashed","dashed"),
col=c("black","gray","gray"),
type="l",
main="Cancer deaths by years since diagnosis",
ylab="Hazard rate per 1000 person-years",
xlab="Years since diagnosis") )
# Plot
with(yearly_rates, matplot(fu,
cbind(rate, lower, upper),
ylim=c(0,max(upper)),
lty=c("solid","dashed","dashed"),
col=c("black","gray","gray"),
type="l",
main="Cancer deaths by years since diagnosis",
ylab="Hazard rate per 1000 person-years",
xlab="Years since diagnosis") )
par(mfrow=c(1,2))
with(yearly_rates, matplot(as.numeric(as.character(fu))+0.5,
cbind(rate, lower,
upper),
ylim=c(0,max(upper)),
lty=c("solid","dashed","dashed"),
col=c("black","gray","gray"),
type="l",
main="Cancer deaths by time since diagnosis",
ylab="Hazard rate per 1000 person-years",
xlab="Years since diagnosis") )
hazfit_f <- muhaz2(Surv(surv_mm/12, status == 1) ~ 1, data = melanoma)
## scale hazard by 1000
plot(hazfit_f, xlab="Years since diagnosis",col="blue",lty="solid", haz.scale=1000, xlim=c(0,10))
with(yearly_rates, matplot(as.numeric(as.character(fu))+0.5,
cbind(rate, lower, upper),
ylim=c(0,max(upper)),
lty=c("solid","dashed","dashed"),
col=c("black","gray","gray"),
type="l",
main="Cancer deaths by years since diagnosis",
ylab="Hazard rate per 1000 person-years",
xlab="Years since diagnosis") )
poisson_g <- glm( status == 1 ~ fu + offset( log(pt) ),
family = poisson,
data = melanoma_10y_spl )
summary(poisson_g)
eform(poisson_g)
summary(poisson_h <- glm( status == 1 ~ fu + year8594 + offset( log(pt) ),
family = poisson,
data = melanoma_10y_spl ))
summary(poisson_h)
eform(poisson_h)
poisson_h2 <- glm( death_cancer ~ fu*year8594 + offset( log(pt) ),
family=poisson,
data=melanoma_10y_spl )
summary(poisson_h2)
eform(poisson_h2)
poisson_h2 <- glm( status == 1 ~ fu*year8594 + offset( log(pt) ),
family=poisson,
data=melanoma_10y_spl )
summary(poisson_h2)
eform(poisson_h2)
poisson_i <- glm( status == 1 ~ fu + year8594 + sex + agegrp + offset( log(pt) ),
family=poisson,
data=melanoma_10y_spl )
summary(poisson_i)
eform(poisson_i)
View(melanoma_10y_spl)
poisson_i <- glm( status == 1 ~ fu + year8594 + sex + agegrp + offset(log(pt)),
family=poisson,
data=melanoma_10y_spl)
summary(poisson_i)
eform(poisson_i)
source('~/cansurv_r/solutions/q111.R', echo=TRUE)
drop1(poisson_i, ~agegrp, test="Chisq")
View(melanoma_10y)
linearHypothesis(poisson_i,c("agegrp45-59 = 0","agegrp60-74 = 0","agegrp75+ = 0"))
poisson_i <- glm( status == 1 ~ fu + year8594 + sex + agegrp + offset(log(pt)),
family=poisson,
data=melanoma_10y_spl)
summary(poisson_i)
eform(poisson_i)
class(agegrp)
class(melanoma$agegrp)
melanoma <- read_dta("melanoma.dta")%>%
filter(stage == 1)%>%
mutate(year8594 = ifelse(year8594 == 1, "Diagnosed 85-94", "Diagnosed 75-84"),
agegrp = as.factor(agegrp),
sex = as.factor(sex))
## Exercise 111
## Created: 2021-03-15 Enoch Chen
## Edited:  2021-03-15 Enoch Chen
## Reference: Biostatistics III in R. https://biostat3.net/download/R/solutions/q7.html
###############################################################################
## Load the packages
library(biostat3)
source('~/cansurv_r/solutions/q111.R', echo=TRUE)
drop1(poisson_i, ~agegrp, test="Chisq")
##(i)-iii. Wald test of the overall effect of age and interpret the results
linearHypothesis(poisson_i,c("agegrp1 = 0","agegrp2 = 0","agegrp3 = 0"))
poisson_j <- glm( status == 1 ~ fu + agegrp + year8594*sex + offset( log(pt) ),
family=poisson, data=melanoma_10y_spl )
poisson_j <- glm( status == 1 ~ fu + agegrp + year8594*sex + offset( log(pt) ),
family=poisson, data=melanoma_10y_spl )
summary(poisson_j)
eform(poisson_j)
##(k) Calculate effect of sex for year8594==2
hr_k <- exp(coef(poisson_j))
hr_k["sex2"]
hr_k <- exp(coef(poisson_j))
hr_k["sex2"]
# Explanation: The effect of sex for patients diagnosed 1975–84 is 0.6031338
hr_k["sex2"]*hr_k["year8594Diagnosed 85-94:sex2"]
# Explanation: The effect of sex for patients diagnosed 1985–94 is 0.6031338
source('~/cansurv_r/solutions/q111.R', echo=TRUE)
source('~/cansurv_r/solutions/q111.R', echo=TRUE)
source('~/cansurv_r/solutions/q111.R', echo=TRUE)
##(k)-ii. Get the estimated effect for patients diagnosed 1985–94 using lincom
biostat3::lincom(poisson_j,c("sex2 + year8594Diagnosed 85-94:sex2"), eform=TRUE)
melanoma_10y_spl <- melanoma_10y_spl %>%
mutate(sex_early = sex==2 & year8594=="Diagnosed 75-84",
sex_latter = sex==2 & year8594=="Diagnosed 85-94")
poisson_k <- glm( status == 1 ~ fu + agegrp + year8594 + sex_early +
sex_latter + offset( log(pt) ),
family=poisson,
data=melanoma_10y_spl )
summary(poisson_k)
eform(poisson_k)
melanoma_10y_spl <- melanoma_10y_spl %>%
mutate(sex_early = sex==2 & year8594=="Diagnosed 75-84",
sex_latter = sex==2 & year8594=="Diagnosed 85-94")
poisson_k <- glm( status == 1 ~ fu + agegrp + year8594 + sex_early +
sex_latter + offset( log(pt) ),
family=poisson,
data=melanoma_10y_spl )
summary(poisson_k)
eform(poisson_k)
##(k)-iv. Add interaction term
poisson_k2 <- glm( status == 1 ~ fu + agegrp + year8594 +
sex:year8594 + offset( log(pt) ),
family=poisson,
data=melanoma_10y_spl )
summary(poisson_k2)
eform(poisson_k2)
poisson_l_early <- glm( status == 1 ~ fu + agegrp + sex + offset( log(pt) ),
family = poisson, data = melanoma_10y_spl,
subset = year8594 == "Diagnosed 75-84" )
summary(poisson_l_early)
eform(poisson_l_early)
poisson_l_later <- glm( status == 1 ~ fu + agegrp + sex + offset( log(pt) ),
family = poisson, data = melanoma_10y_spl,
subset = year8594 == "Diagnosed 85-94" )
summary(poisson_l_later)
eform(poisson_l_later)
poisson_l2 <- glm( status == 1 ~ fu + fu:year8594 + agegrp + agegrp:year8594
+ sex*year8594 + offset( log(pt) ),
family=poisson, data=melanoma_10y_spl )
summary(poisson_l2)
eform(poisson_l2)
source('~/cansurv_r/solutions/q111.R', echo=TRUE)
## Exercise 112
## Created: 2021-03-22 Enoch Chen
## Edited:  2021-03-22 Enoch Chen
## Reference: Biostatistics III in R. https://biostat3.net/download/R/solutions/q8.html
###############################################################################
## Load the packages
library(biostat3)
library(haven)
library(dplyr) # manipulate data
library(bshazard)  # for bshazard
## Read data
diet <- read_dta("diet.dta")
## Check the loaded data
head(diet)
install.packages("bshazard")
## Load the packages
library(biostat3)
library(haven)
library(dplyr) # manipulate data
library(bshazard)  # for bshazard
??bshazard
scale <- 365.24
plot(bshazard(Surv((doe - dob)/scale, (dox - dob)/scale, chd) ~ 1,
data=subset(diet,hieng=="low")),
ylim=c(0,0.03), conf.int=FALSE, xlab="Attained age (years)")
library(bshazard)  # for nonparametric smoothing of hazard function
install.packages("Epi")
library(bshazard)  # for nonparametric smoothing of hazard function
scale <- 365.24
plot(bshazard(Surv((doe - dob)/scale, (dox - dob)/scale, chd) ~ 1,
data=subset(diet,hieng=="low")),
ylim=c(0,0.03), conf.int=FALSE, xlab="Attained age (years)")
library(bshazard)  # for nonparametric smoothing of hazard function
##(a) Incidence rates by attained age
scale <- 365.24
plot(bshazard(Surv((doe - dob)/scale, (dox - dob)/scale, chd) ~ 1,
data=subset(diet,hieng=="low")),
ylim=c(0,0.03), conf.int=FALSE, xlab="Attained age (years)")
fit_a <- Surv((doe - dob)/scale, (dox - dob)/scale, chd) ~ 1,
data=subset(diet, hieng=="low"))
View(diet)
fit_a <- Surv((doe - dob)/scale, (dox - dob)/scale, chd) ~ 1,
data=subset(diet, hieng== 0 )
fit_a <- Surv((doe - dob)/scale, (dox - dob)/scale, chd) ~ 1,
data=subset(diet, hieng== "0")
scale <- 365.24
plot(bshazard(Surv((doe - dob)/scale, (dox - dob)/scale, chd) ~ 1,
data=subset(diet,hieng=="0")),
ylim=c(0,0.03), conf.int=FALSE, xlab="Attained age (years)")
rlang::last_error()
class(diet:doe)
class(diet$doe)
plot(bshazard(Surv((doe - dob)/scale, (dox - dob)/scale, chd) ~ 1,
data=subset(diet,hieng=="0")),
ylim=c(0,0.03), conf.int=FALSE, xlab="Attained age (years)")
plot(bshazard(Surv((doe - dob)/scale, (dox - dob)/scale, chd) ~ 1,
data=subset(diet,hieng ="0")),
ylim=c(0,0.03), conf.int=FALSE, xlab="Attained age (years)")
lines(bshazard(Surv((doe - dob)/scale, (dox - dob)/scale, chd) ~ 1,
data=subset(diet,hieng = "1")),
col="red", conf.int=FALSE)
plot(bshazard(Surv((doe - dob)/scale, (dox - dob)/scale, chd) ~ 1,
data=subset(diet,hieng = "0")),
ylim=c(0,0.03), conf.int=FALSE, xlab="Attained age (years)")
lines(bshazard(Surv((doe - dob)/scale, (dox - dob)/scale, chd) ~ 1,
data=subset(diet,hieng = "1")),
col="red", conf.int=FALSE)
class(diet$hieng)
diet <- transform(diet, ifelse(hieng = "0", "low", "high"))
diet <- read_dta("diet.dta")
#' hieng is coded as follows
#' 0 [low]
#' 1 [high]
diet <- transform(diet, ifelse(hieng == "0", "low", "high"))
diet <- transform(diet, ifelse(hieng == "0", "low", "high"))
diet <- transform(diet, hieng = ifelse(hieng == "0", "low", "high"))
diet <- transform(diet, hieng = ifelse(hieng = "0", "low", "high"))
diet <- transform(diet, hieng = ifelse(hieng == "0", "low", "high"))
diet <- mutate(diet, hieng = ifelse(hieng == 0, "low", "high"))
View(diet)
plot(bshazard(Surv((doe - dob)/scale, (dox - dob)/scale, chd) ~ 1,
data=subset(diet, hieng == "low")),
ylim=c(0,0.03), conf.int=FALSE, xlab="Attained age (years)")
lines(bshazard(Surv((doe - dob)/scale, (dox - dob)/scale, chd) ~ 1,
data=subset(diet, hieng == "high")),
col="red", conf.int=FALSE)
legend("topleft", legend=c('hieng=="low"','hieng=="high"'), col=1:2, lty=1, bty="n")
# Incidence rates by time since diagnosis
plot(muhaz2(Surv((dox - doe)/scale, chd) ~ hieng, data=diet), lty=2,
xlab="Time since study entry (years)", ylim=c(0,0.025),
legend=FALSE)
lines(bshazard(Surv((dox - doe)/scale, chd) ~ 1, data=subset(diet,hieng=="low")),
conf.int=FALSE)
plot(muhaz2(Surv((dox - doe)/scale, chd) ~ hieng, data=diet), lty=2,
xlab="Time since study entry (years)", ylim=c(0,0.025),
legend=FALSE)
plot(muhaz2(Surv((dox - doe)/scale, chd) ~ hieng, data=diet), lty=2,
xlab="Time since study entry (years)", ylim=c(0,0.025),
legend=FALSE)
legend("topleft", legend=c('hieng=="low"','hieng=="high"'), col=1:2, bty="n")
plot(muhaz2(Surv((dox - doe)/scale, chd) ~ hieng, data=diet), lty=2,
xlab="Time since study entry (years)", ylim=c(0,0.025),
legend=FALSE)
legend("topleft", legend=c('hieng=="low"','hieng=="high"'), col=1:2, lty=1, bty="n")
plot(muhaz2(Surv((dox - doe)/scale, chd) ~ hieng, data=diet),
xlab="Time since study entry (years)", ylim=c(0,0.025),
legend=FALSE)
legend("topleft", legend=c('hieng=="low"','hieng=="high"'), col=1:2, lty=1, bty="n")
plot(muhaz2(Surv((dox - doe)/scale, chd) ~ hieng, data=diet),
xlab="Time since study entry (years)", ylim=c(0,0.025),
legend=FALSE)
legend("topleft", legend=c('hieng=="low"','hieng=="high"'), col=1:2, lty=1, bty="n")
# Incidence rates by time since diagnosis
plot(muhaz2(Surv((dox - doe)/scale, chd) ~ hieng, data=diet),
xlab="Time since study entry (years)", ylim=c(0,0.025),
legend=FALSE)
legend("topleft", legend=c('hieng=="low"','hieng=="high"'), col=1:2, lty=1, bty="n")
plot(muhaz2(Surv((dox - doe)/scale, chd) ~ hieng, data=diet), lty=1,
xlab="Time since study entry (years)", ylim=c(0,0.025),
legend=FALSE)
legend("topleft", legend=c('hieng=="low"','hieng=="high"'), col=1:2, lty=1, bty="n")
##(b) Modelling the rate, no adjustment for timescale
poisson_b <- glm( chd ~ hieng + offset( log( y1k ) ),
family=poisson, data=diet)
summary(poisson_b)
summary(poisson_b)
diet <- mutate(diet, hieng = ifelse(hieng == 0, "low", "high"),
y1k = y / 1000)
poisson_b <- glm( chd ~ hieng + offset( log( y1k ) ),
family=poisson, data=diet)
summary(poisson_b)
summary(poisson_b)
poisson_b <- glm( chd ~ hieng + offset( log( y1k ) ),
family=poisson, data=diet)
diet <- mutate(diet, hieng = ifelse(hieng == 0, "low", "high"),
y1k = y / 1000)
View(diet)
poisson_b <- glm( chd ~ hieng + offset( log( y1k ) ),
family=poisson, data=diet)
class(diet$hieng)
class(diet$chd)
poisson_b <- glm( chd ~ hieng + offset( log( y1k ) ),
family=poisson, data=diet)
poisson_b <- glm( chd ~ hieng + offset( log( y1k ) ), family=poisson, data=diet)
diet$y1k <- diet$y/1000
poisson_b <- glm( chd ~ hieng + offset( log( y1k ) ), family=poisson, data=diet)
source('~/cansurv_r/solutions/q110.R', echo=TRUE)
library(biostat3)
library(haven)
library(dplyr) # manipulate data
library(bshazard)  # for nonparametric smoothing of hazard function
## Read data
diet <- read_dta("diet.dta")
#' hieng (energy intake) is coded as follows
#' 0 [low]
#' 1 [high]
diet <- mutate(diet, hieng = ifelse(hieng == 0, "low", "high"),
y1k = y / 1000)
poisson_b <- glm( chd ~ hieng + offset( log( y1k ) ), family=poisson, data=diet)
summary(poisson_b)
eform(poisson_b)
??glm
poisson_b <- glm( chd ~ hieng(hieng=="low") + offset( log( y1k ) ), family=poisson, data=diet)
diet <- mutate(diet, hieng = ifelse(hieng == 0, "low", "high"),
hieng = relevel(hieng, ref = "low"),
y1k = y / 1000)
??relevel
diet <- within(diet, hieng = relevel(hieng, ref = "low"))
diet <- within(diet, hieng = relevel(hieng, ref == "low"))
diet <- within(diet, hieng <- relevel(hieng, ref = "low"))
diet$hieng <- relevel(diet$hieng, ref = "low")
class(diet$hieng)
library(biostat3)
library(haven)
library(dplyr) # manipulate data
library(bshazard)  # for nonparametric smoothing of hazard function
## Read data
diet <- read_dta("diet.dta")
#' hieng (energy intake) is coded as follows
#' 0 [low]
#' 1 [high]
diet <- mutate(diet, hieng = ifelse(hieng == 1, "high", "low"),
y1k = y / 1000)
poisson_b <- glm( chd ~ hieng + offset( log( y1k ) ), family=poisson, data=diet)
summary(poisson_b)
eform(poisson_b)
diet$hieng <- relevel(diet$hieng, ref = "low")
poisson_b <- glm( chd ~ hieng + relevel(hieng, ref = "low") + offset( log( y1k ) ),
family=poisson, data=diet)
diet <- mutate(diet, hieng = as.factor(ifelse(hieng == 1, "high", "low")),
y1k = y / 1000)
poisson_b <- glm( chd ~ hieng + relevel(hieng, ref = "low") + offset( log( y1k ) ),
family=poisson, data=diet)
diet$hieng <- relevel(hieng, ref = "low")
diet$hieng <- relevel(diet$hieng, ref = "low")
poisson_b <- glm( chd ~ hieng + offset( log( y1k ) ),
family=poisson, data=diet)
## Exercise 112
## Created: 2021-03-22 Enoch Chen
## Edited:  2021-03-22 Enoch Chen
## Reference: Biostatistics III in R. https://biostat3.net/download/R/solutions/q8.html
###############################################################################
## Load the packages
library(biostat3)
library(haven)
library(dplyr) # manipulate data
library(bshazard)  # for nonparametric smoothing of hazard function
## Read data
diet <- read_dta("diet.dta")
#' hieng (energy intake) is coded as follows
#' 0 [low]
#' 1 [high]
diet <- mutate(diet, hieng = as.factor(ifelse(hieng == 1, "high", "low")),
y1k = y / 1000)
diet$hieng <- relevel(diet$hieng, ref = "low")
View(diet)
poisson_b <- glm( chd ~ hieng + offset( log( y1k ) ),
family=poisson, data=diet)
summary(poisson_b)
eform(poisson_b)
# Create BMI variable
diet$bmi <- diet$weight/((diet$height/100)^2)
# Create orderly varable instead of categorical, start at zero
levels(diet$job)
# Create BMI variable
diet$bmi <- diet$weight/((diet$height/100)^2)
# Create orderly varable instead of categorical, start at zero
levels(diet$job)
class(diet$job)
levels(diet$job)
poisson_c <- glm( chd ~ hieng + job + bmi + offset( log( y1k ) ),
family=poisson, data=diet)
summary(poisson_c)
eform(poisson_c)
source('~/cansurv_r/solutions/q112.R', echo=TRUE)
