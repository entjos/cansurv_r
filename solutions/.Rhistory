<<<<<<< HEAD
var="female",
ci=TRUE)
lines(fpm_i, newdata=newdata_i2,
type="hr",
var="female",
ci=TRUE, line.col = "green")
plot(fpm_i, newdata=newdata_i1,
=======
legend("topright")
plot(fpm_a, newdata=newdata1,
>>>>>>> afd334f18890f618ee0957e564f6b540d44957d9
xlab="Time since diagnosis (years)",
ylab="Cause specific mortality rate (per pys)",
type="haz", ci=FALSE, ylim=c(0,0.3), col=1, lty=1)
lines(fpm_b, newdata=newdata1, type="haz", col=2, lty=1)
lines(fpm_a, newdata=newdata4, type="haz", col=1, lty=2)
lines(fpm_b, newdata=newdata4, type="haz", col=2, lty=2)
?legend
plot(fpm_a, newdata=newdata1,
xlab="Time since diagnosis (years)",
ylab="Cause specific mortality rate (per pys)",
type="haz", ci=FALSE, ylim=c(0,0.3), col=1)
lines(fpm_b, newdata=newdata1, type="haz", col=2)
lines(fpm_a, newdata=newdata4, type="haz", col=3)
lines(fpm_b, newdata=newdata4, type="haz", col=4)
legend("topright", legend=c("PH agegrp0", "PO agegrp0", "PH agegrp4", "PO agegrp4"), col=1:4)
plot(fpm_a, newdata=newdata1,
xlab="Time since diagnosis (years)",
ylab="Cause specific mortality rate (per pys)",
type="haz", ci=FALSE, ylim=c(0,0.3), col=1)
lines(fpm_b, newdata=newdata1, type="haz", col=2)
lines(fpm_a, newdata=newdata4, type="haz", col=3)
plot(fpm_a, newdata=newdata1,
xlab="Time since diagnosis (years)",
ylab="Cause specific mortality rate (per pys)",
type="haz", ci=FALSE, ylim=c(0,0.3))
lines(fpm_b, newdata=newdata1, type="haz", col=2)
lines(fpm_a, newdata=newdata4, type="haz", col=3)
(fpm_b, newdata=newdata4, type="haz", col=4)
lines(fpm_b, newdata=newdata4, type="haz", col=4)
legend("topright", legend=c("PH agegrp0", "PO agegrp0", "PH agegrp4", "PO agegrp4"), col=1:4)
legend("topright", legend=c("PH agegrp0", "PO agegrp0", "PH agegrp4", "PO agegrp4"), col=c(1:4))
plot(fpm_a, newdata=newdata1,
xlab="Time since diagnosis (years)",
ylab="Cause specific mortality rate (per pys)",
type="haz", ci=FALSE, ylim=c(0,0.3))
lines(fpm_b, newdata=newdata1, type="haz", col=2)
lines(fpm_a, newdata=newdata4, type="haz", col=3)
plot(fpm_a, newdata=newdata1,
xlab="Time since diagnosis (years)",
ylab="Cause specific mortality rate (per pys)",
type="haz", ci=FALSE, ylim=c(0,0.3))
lines(fpm_b, newdata=newdata1, type="haz", col=2)
lines(fpm_a, newdata=newdata4, type="haz", col=3)
lines(fpm_b, newdata=newdata4, type="haz", col=4)
legend("topright", legend=c("PH agegrp0", "PO agegrp0", "PH agegrp4", "PO agegrp4"), col=c("black","red","green","blue"))
legend("topright", legend=c("PH agegrp0", "PO agegrp0", "PH agegrp4", "PO agegrp4"), col=c("black","red","green","blue"))
legend("topright", legend = c("PH agegrp0", "PO agegrp0", "PH agegrp4", "PO agegrp4"),
col = c("black", "red", "green", "blue"))
legend("topright", legend = c("PH agegrp0", "PO agegrp0", "PH agegrp4", "PO agegrp4"),
col = c("black", "red", "green", "blue"))
legend("topright", legend = c("PH agegrp0", "PO agegrp0", "PH agegrp4", "PO agegrp4"),
col = 1:4)
legend("topright", c("PH agegrp0", "PO agegrp0", "PH agegrp4", "PO agegrp4"),
col = 1:4)
plot(fpm_a, newdata=newdata1,
xlab="Time since diagnosis (years)",
ylab="Cause specific mortality rate (per pys)",
type="haz", ci=FALSE, ylim=c(0,0.3))
lines(fpm_b, newdata=newdata1, type="haz", col=2)
lines(fpm_a, newdata=newdata4, type="haz", col=3)
lines(fpm_b, newdata=newdata4, type="haz", col=4)
legend("topright", legend = c("PH agegrp0", "PO agegrp0", "PH agegrp4", "PO agegrp4"),
col = c("black", "red", "green", "blue"))
legend("topright", legend = c("PH agegrp0", "PO agegrp0", "PH agegrp4", "PO agegrp4"),
col = c("black", "red", "green", "blue"), lty = 1)
legend("topright", legend = c("PH agegrp0", "PO agegrp0", "PH agegrp4", "PO agegrp4"),
col = 1:4, lty = 1)
plot(fpm_a, newdata=newdata1,
xlab="Time since diagnosis (years)",
ylab="Cause specific mortality rate (per pys)",
type="haz", ci=FALSE, ylim=c(0,0.3))
lines(fpm_b, newdata=newdata1, type="haz", col=2)
lines(fpm_a, newdata=newdata4, type="haz", col=3)
lines(fpm_b, newdata=newdata4, type="haz", col=4)
legend("topright", legend = c("PH agegrp0", "PO agegrp0", "PH agegrp4", "PO agegrp4"),
col = 1:4, lty = 1)
plot(fpm_a, newdata=newdata1,
xlab="Time since diagnosis (years)",
ylab="Cause specific mortality rate (per pys)",
type="haz", ci=FALSE, ylim=c(0,0.3))
lines(fpm_b, newdata=newdata1, type="haz", col=2)
lines(fpm_a, newdata=newdata4, type="haz", col=3)
lines(fpm_b, newdata=newdata4, type="haz", col=4)
legend("topright", legend = c("PH agegrp0", "PO agegrp0", "PH agegrp4", "PO agegrp4"),
col = 1:4, lty = 1)
## Survival function
plot(fpm_a, newdata=newdata1,
xlab="Time since diagnosis (years)",
ylab="Survival probability",
type="surv", ci=FALSE, ylim=c(0,1))
lines(fpm_b, newdata=newdata1, type="surv", col=2)
lines(fpm_a, newdata=newdata4, type="surv", col=3)
lines(fpm_b, newdata=newdata4, type="surv", col=4)
legend("topright", legend = c("PH agegrp0", "PO agegrp0", "PH agegrp4", "PO agegrp4"),
col = 1:4, lty = 1)
legend("bottomright", legend = c("PH agegrp0", "PO agegrp0", "PH agegrp4", "PO agegrp4"),
col = 1:4, lty = 1)
## Survival function
plot(fpm_a, newdata=newdata1,
xlab="Time since diagnosis (years)",
ylab="Survival probability",
type="surv", ci=FALSE, ylim=c(0,1))
lines(fpm_b, newdata=newdata1, type="surv", col=2)
lines(fpm_a, newdata=newdata4, type="surv", col=3)
lines(fpm_b, newdata=newdata4, type="surv", col=4)
legend("bottomright", legend = c("PH agegrp0", "PO agegrp0", "PH agegrp4", "PO agegrp4"),
col = 1:4, lty = 1)
## Hazard function
plot(fpm_a, newdata=newdata1,
xlab="Time since diagnosis (years)",
ylab="Hazard rates",
type="haz", ci=FALSE, ylim=c(0,0.3))
lines(fpm_b, newdata=newdata1, type="haz", col=2)
lines(fpm_a, newdata=newdata4, type="haz", col=3)
lines(fpm_b, newdata=newdata4, type="haz", col=4)
legend("topright", legend = c("PH agegrp0", "PO agegrp0", "PH agegrp4", "PO agegrp4"),
col = 1:4, lty = 1)
AIC(fpm_a)
AIC(fpm_a, fpm_b)
BIC(fpm_a, fpm_b)
## Exercise 133
## Created: 2022-01-05 Enoch Chen
## Edited:  2022-01-05 Enoch Chen
###############################################################################
## Load the packages
library(biostat3)
library(haven)
library(dplyr)   # manipulate data
library(rstpm2)
library(ggplot2) # ggplot
## Read data
melanoma <- read_dta("melanoma.dta")%>%
mutate(year8594 = ifelse(year8594 == 1, "Diagnosed 85-94", "Diagnosed 75-84"),
female = ifelse(sex == 2, +1, +0), # Create a female variable
event  = ifelse((status == 1) & surv_mm<= 60.5, 1, 0), # Redefine status
surv_mm = ifelse(surv_mm<= 60.5, surv_mm, 60.5),       # censored everyone after 60 months
t = surv_mm/12,                                     # surv_mm in years
agegrp1 = (agegrp== 0)+0, # used by time-dependent effect
agegrp2 = (agegrp== 1)+0, # used by time-dependent effect
agegrp3 = (agegrp== 2)+0, # used by time-dependent effect
agegrp4 = (agegrp== 3)+0) # used by time-dependent effect
melanoma <- melanoma %>%
mutate(year8594 = as_factor(year8594),
agegrp = as_factor(agegrp))
str(melanoma)
#' status is coded as follows
#' 1 [Dead: cancer]
#' 2 [Dead: other]
#' 0 [Alive]
#' 4 [Lost to follow-up]
#' agegrp is coded as follows
#' 0 [0-44]  -> agegrp1
#' 1 [45-59] -> agegrp2
#' 2 [60-74] -> agegrp3
#' 3 [75+]   -> agegrp4
##(a) Proportional Hazards model
#' g(S)=log(-log(S))
ph <- stpm2(Surv(t, event) ~ female + year8594 + agegrp2 + agegrp3 + agegrp4, data = melanoma, df=4)
summary(ph)
eform(ph)
## (b) Proportional Odds Model
#' g(S)=-logit(S)
po <- stpm2(Surv(t, event) ~ female + year8594 + agegrp2 + agegrp3 + agegrp4, data = melanoma, df=4,
link.type = "PO")
summary(po)
eform(po)
## (c) Compare survival and hazard function
## Prepare empty datasets for prediction
years <- levels(melanoma$year8594)
agegrps <- levels(melanoma$agegrp)
newdata1 <- data.frame(female=0, year8594=years[1], agegrp2=0, agegrp3=0, agegrp4=0)
newdata4 <- data.frame(female=0, year8594=years[1], agegrp2=0, agegrp3=0, agegrp4=1)
## Survival function
plot(ph, newdata=newdata1,
xlab="Time since diagnosis (years)",
ylab="Survival probability",
type="surv", ci=FALSE, ylim=c(0,1))
lines(po, newdata=newdata1, type="surv", col=2)
lines(ph, newdata=newdata4, type="surv", col=3)
lines(po, newdata=newdata4, type="surv", col=4)
legend("bottomright", legend = c("PH agegrp0", "PO agegrp0", "PH agegrp4", "PO agegrp4"),
col = 1:4, lty = 1)
## Hazard function
plot(ph, newdata=newdata1,
xlab="Time since diagnosis (years)",
ylab="Hazard rates",
type="haz", ci=FALSE, ylim=c(0,0.3))
lines(po, newdata=newdata1, type="haz", col=2)
lines(ph, newdata=newdata4, type="haz", col=3)
lines(po, newdata=newdata4, type="haz", col=4)
legend("topright", legend = c("PH agegrp0", "PO agegrp0", "PH agegrp4", "PO agegrp4"),
col = 1:4, lty = 1)
##(d) Compare AIC and BIC
AIC(ph, po)
BIC(ph, po)
plot(po, newdata=newdata1,
xlab="Time since diagnosis (years)",
ylab="Hazard ratio",
var="female",
type="hr", ci=TRUE, ylim=c(0.45,0.65))
newdata3 <- data.frame(female=0, year8594=years[1], agegrp2=0, agegrp3=1, agegrp4=0)
lines(po, newdata=newdata3,
var="female",
type="hr", ci=FALSE)
plot(po, newdata=newdata1,
xlab="Time since diagnosis (years)",
ylab="Hazard ratio",
var="female",
type="hr", ci=FALSE, ylim=c(0.5,0.7))
lines(po, newdata=newdata3,
var="female",
type="hr", ci=FALSE)
lines(po, newdata=newdata3,
var="female",
type="hr", ci=FALSE, col=2)
years[1]
plot(po, newdata=newdata1,
xlab="Time since diagnosis (years)",
ylab="Hazard ratio",
var="female",
type="hr", ci=FALSE, ylim=c(0.5,0.7))
lines(po, newdata=newdata4,
var="female",
type="hr", ci=FALSE, col=2)
ao <- stpm2(Surv(t, event) ~ female + year8594 + agegrp2 + agegrp3 + agegrp4, data = melanoma, df=4,
link.type = "AO")
summary(ao)
AIC(ph, po, ao)
BIC(ph, po, ao)
?lincom
##(h) Show estimate of theta with 95% CI
lincom(po, eform=TRUE)
ao <- stpm2(Surv(t, event) ~ female + year8594 + agegrp2 + agegrp3 + agegrp4, data = melanoma, df=4,
link.type = "AO")
summary(ao)
lincom(po, c("female"), eform=TRUE)
lincom(po, "female", eform=TRUE)
summary(po)
lincom(po, c("female","female+year8594Diagnosed 85-94"), eform=TRUE)
##(h) Show estimate of theta with 95% CI
lincom(po, ("female"), eform=TRUE)
##(h) Show estimate of theta with 95% CI
lincom(po, "female", eform=TRUE)
##(h) Show estimate of theta with 95% CI
lincom(po, hypothesis.matrix, eform=TRUE)
##(h) Show estimate of theta with 95% CI
lincom(po, c("(Intercept)", "repwt = 1"), eform=TRUE)
##(h) Show estimate of theta with 95% CI
lincom(po, coefs[-1], eform=TRUE)
##(h) Show estimate of theta with 95% CI
lincom(po, "female = 0", eform=TRUE)
##(h) Show estimate of theta with 95% CI
lincom(po, "female = 1", eform=TRUE)
##(h) Show estimate of theta with 95% CI
lincom(po, c("female = 0", "female = 1"), eform=TRUE)
##(h) Show estimate of theta with 95% CI
lincom(po, c("(Intercept) = 0"), eform=TRUE)
##(h) Show estimate of theta with 95% CI
lincom(po, "(Intercept) = 0", eform=TRUE)
##(h) Show estimate of theta with 95% CI
lincom(po, c("(Intercept) = 0", "female = 1"), eform=TRUE)
##(h) Show estimate of theta with 95% CI
coefs <- names(coef(po))
lincom(po, coefs[-1], eform=TRUE)
lincom(po, "coefs[-1]", eform=TRUE)
coefs[-1]
lincom(po, c(coefs[-1]), eform=TRUE)
c(coefs[-1])
lincom(po, c(coefs[-1]=0), eform=TRUE)
linearHypothesis(po, coefs[-1])
library(car)
linearHypothesis(po, coefs[-1])
linearHypothesis(po, coefs[-1])
linearHypothesis(po, coefs[-1])
##(h) Show estimate of theta with 95% CI
coefs <- names(coef(po))
lincom(po, c(coefs[-1]), eform=TRUE)
lincom(po, c("female + year8594Diagnosed 85-94 + agegrp2 + agegrp3 + agegrp4 +
nsx(log(t), df = 4)1 + nsx(log(t), df = 4)2 + nsx(log(t), df = 4)3 + nsx(log(t), df = 4)4", eform=TRUE)
lincom(po, c("female + year8594Diagnosed 85-94 + agegrp2 + agegrp3 + agegrp4 +
nsx(log(t), df = 4)1 + nsx(log(t), df = 4)2 + nsx(log(t), df = 4)3 + nsx(log(t), df = 4)4"), eform=TRUE)
lincom(po, c("female + year8594Diagnosed 85-94 + agegrp2 + agegrp3 + agegrp4 + nsx(log(t), df = 4)1 + nsx(log(t), df = 4)2 + nsx(log(t), df = 4)3 + nsx(log(t), df = 4)4"), eform=TRUE)
lincom(po, c("female + year8594Diagnosed 85-94 + agegrp2 + agegrp3 + agegrp4"), eform=TRUE)
lincom(po, c("female + year8594Diagnosed 85-94"), eform=TRUE)
lincom(po, c("female + year8594Diagnosed 85-94 + agegrp2 + agegrp3 + agegrp4 + nsx(log(t), df = 4)1 + nsx(log(t), df = 4)2 + nsx(log(t), df = 4)3 + nsx(log(t), df = 4)4"), eform=TRUE)
lincom(po, "female + year8594Diagnosed 85-94 + agegrp2 + agegrp3 + agegrp4 + nsx(log(t), df = 4)1 + nsx(log(t), df = 4)2 + nsx(log(t), df = 4)3 + nsx(log(t), df = 4)4", eform=TRUE)
lincom(po, "year8594Diagnosed 85-94", eform=TRUE)
biostat3::lincom(po, "year8594Diagnosed 85-94", eform=TRUE)
biostat3::lincom(po, c("year8594Diagnosed 85-94"), eform=TRUE)
## Exercise 133
## Created: 2022-01-05 Enoch Chen
## Edited:  2022-01-05 Enoch Chen
###############################################################################
## Load the packages
library(biostat3)
library(haven)
library(dplyr)   # manipulate data
library(rstpm2)
library(ggplot2) # ggplot
## Read data
melanoma <- read_dta("melanoma.dta")%>%
mutate(year8594 = ifelse(year8594 == 1, "Diagnosed 85-94", "Diagnosed 75-84"),
female = ifelse(sex == 2, +1, +0), # Create a female variable
event  = ifelse((status == 1) & surv_mm<= 60.5, 1, 0), # Redefine status
surv_mm = ifelse(surv_mm<= 60.5, surv_mm, 60.5),       # censored everyone after 60 months
t = surv_mm/12,                                     # surv_mm in years
agegrp1 = (agegrp== 0)+0, # used by time-dependent effect
agegrp2 = (agegrp== 1)+0, # used by time-dependent effect
agegrp3 = (agegrp== 2)+0, # used by time-dependent effect
agegrp4 = (agegrp== 3)+0) # used by time-dependent effect
melanoma <- melanoma %>%
mutate(year8594 = as_factor(year8594),
agegrp = as_factor(agegrp))
str(melanoma)
#' status is coded as follows
#' 1 [Dead: cancer]
#' 2 [Dead: other]
#' 0 [Alive]
#' 4 [Lost to follow-up]
#' agegrp is coded as follows
#' 0 [0-44]  -> agegrp1
#' 1 [45-59] -> agegrp2
#' 2 [60-74] -> agegrp3
#' 3 [75+]   -> agegrp4
##(a) Proportional Hazards model
#' g(S)=log(-log(S))
ph <- stpm2(Surv(t, event) ~ female + year8594 + agegrp2 + agegrp3 + agegrp4, data = melanoma, df=4)
summary(ph)
eform(ph)
## (b) Proportional Odds Model
#' g(S)=-logit(S)
po <- stpm2(Surv(t, event) ~ female + year8594 + agegrp2 + agegrp3 + agegrp4, data = melanoma, df=4,
link.type = "PO")
summary(po)
eform(po)
lincom(po, c("year8594Diagnosed 85-94"), eform=TRUE)
po1 <- stpm2(Surv(t, event) ~ sex, data = melanoma, df=4,
link.type = "PO")
summary(po1)
lincom(po, c("sex"), eform=TRUE)
lincom(po, "sex", eform=TRUE)
## Load the packages
library(biostat3)
library(haven)
library(dplyr)   # manipulate data
library(rstpm2)
library(ggplot2) # ggplot
po1 <- stpm2(Surv(t, event) ~ sex, data = biostat3::melanoma, df=4,
link.type = "PO")
po1 <- stpm2(Surv(t, event) ~ sex, data = biostat3::melanoma, df=4,
link.type = "PO")
library(biostat3)
library(haven)
library(dplyr)   # manipulate data
library(rstpm2)
library(ggplot2) # ggplot
po1 <- stpm2(Surv(t, event) ~ sex, data = biostat3::melanoma, df=4,
link.type = "PO")
melanoma
melanoma <- biostat3::melanoma
po1 <- stpm2(Surv(t, event) ~ sex, data = melanoma, df=4,
link.type = "PO")
melanoma <- melanoma %>%
mutate(event  = ifelse((status == 1) & surv_mm<= 60.5, 1, 0), # Redefine status
surv_mm = ifelse(surv_mm<= 60.5, surv_mm, 60.5),       # censored everyone after 60 months
t = surv_mm/12) # surv_mm in years
po1 <- stpm2(Surv(t, event) ~ sex, data = melanoma, df=4,
link.type = "PO")
po1 <- stpm2(Surv(t, event) ~ sex, data = melanoma, df=4,
link.type = "PO")
po1 <- stpm2(Surv(t, event) ~ sex, data = melanoma, df=4,
link.type = "PO")
po1 <- stpm2(Surv(t, event) ~ sex, data = melanoma, df=4,
link.type = "PO")
summary(poisson7j <- glm( death_cancer ~ fu + agegrp + year8594*sex + offset( log(pt) ), family=poisson, data=melanoma.spl ))
melanoma.l <- filter(biostat3::melanoma, stage=="Localised")
head( melanoma.l )
summary(melanoma.l)
summary(poisson7j <- glm( death_cancer ~ fu + agegrp + year8594*sex + offset( log(pt) ), family=poisson, data=melanoma.spl ))
biostat3::lincom(poisson7j,c("sexFemale + year8594Diagnosed 85-94:sexFemale"),eform=TRUE)
## Exercise 133
## Created: 2022-01-05 Enoch Chen
## Edited:  2022-01-05 Enoch Chen
###############################################################################
## Load the packages
library(biostat3)
library(haven)
library(dplyr)   # manipulate data
library(rstpm2)
library(ggplot2) # ggplot
## Read data
melanoma <- read_dta("melanoma.dta")%>%
mutate(year8594 = ifelse(year8594 == 1, "Diagnosed 85-94", "Diagnosed 75-84"),
female = ifelse(sex == 2, +1, +0), # Create a female variable
event  = ifelse((status == 1) & surv_mm<= 60.5, 1, 0), # Redefine status
surv_mm = ifelse(surv_mm<= 60.5, surv_mm, 60.5),       # censored everyone after 60 months
t = surv_mm/12,                                     # surv_mm in years
agegrp1 = (agegrp== 0)+0, # used by time-dependent effect
agegrp2 = (agegrp== 1)+0, # used by time-dependent effect
agegrp3 = (agegrp== 2)+0, # used by time-dependent effect
agegrp4 = (agegrp== 3)+0) # used by time-dependent effect
melanoma <- melanoma %>%
mutate(year8594 = as_factor(year8594),
agegrp = as_factor(agegrp))
str(melanoma)
#' status is coded as follows
#' 1 [Dead: cancer]
#' 2 [Dead: other]
#' 0 [Alive]
#' 4 [Lost to follow-up]
#' agegrp is coded as follows
#' 0 [0-44]  -> agegrp1
#' 1 [45-59] -> agegrp2
#' 2 [60-74] -> agegrp3
#' 3 [75+]   -> agegrp4
##(a) Proportional Hazards model
#' g(S)=log(-log(S))
ph <- stpm2(Surv(t, event) ~ female + year8594 + agegrp2 + agegrp3 + agegrp4, data = melanoma, df=4)
summary(ph)
eform(ph)
## (b) Proportional Odds Model
#' g(S)=-logit(S)
po <- stpm2(Surv(t, event) ~ female + year8594 + agegrp2 + agegrp3 + agegrp4, data = melanoma, df=4,
link.type = "PO")
summary(po)
eform(po)
## (c) Compare survival and hazard function
## Prepare empty datasets for prediction
years <- levels(melanoma$year8594)
agegrps <- levels(melanoma$agegrp)
<<<<<<< HEAD
newdata1 <- data.frame(female=females[1], year8594=years[1], agegrp2=0, agegrp3=0, agegrp4=0)
newdata2 <- data.frame(female=females[1], year8594=years[1], agegrp2=1, agegrp3=0, agegrp4=0)
newdata3 <- data.frame(female=females[1], year8594=years[1], agegrp2=0, agegrp3=1, agegrp4=0)
newdata4 <- data.frame(female=females[1], year8594=years[1], agegrp2=0, agegrp3=0, agegrp4=1)
plot(fpm_b, newdata=newdata1,
xlab="Time since diagnosis (years)",
ylab="Cause specific mortality rate (per pys)",
type="haz", ci=FALSE, ylim=c(0,0.2))
lines(fpm_b, newdata=newdata2, type="haz", lty=2)
lines(fpm_b, newdata=newdata3, type="haz", lty=3)
lines(fpm_b, newdata=newdata4, type="haz", lty=4)
legend("topright", legend=paste0(agegrps), lty=1:4)
##(c) Time-dependent effects for age group
fpm_c <- stpm2(Surv(t, event) ~ female + year8594 + agegrp2 + agegrp3 + agegrp4,
tvc=list(agegrp2= 2 , agegrp3= 2 , agegrp4 = 2), data = melanoma, df=4)
summary(fpm_c)
eform(fpm_c)
#Likelihood-ratio test
anova(fpm_b, fpm_c)
##(d) predict the hazard for each age group
plot(fpm_b, newdata=newdata1,
xlab="Time since diagnosis (years)",
ylab="Cause specific mortality rate (per pys)",
type="haz", ci=FALSE, ylim=c(0,0.2), line.col = "red")
lines(fpm_c, newdata=newdata1, type="haz", lty=2, col = "red")
lines(fpm_b, newdata=newdata2, type="haz", lty=1, col = "blue")
lines(fpm_c, newdata=newdata2, type="haz", lty=2, col = "blue")
lines(fpm_b, newdata=newdata3, type="haz", lty=1, col = "purple")
lines(fpm_c, newdata=newdata3, type="haz", lty=2, col = "purple")
lines(fpm_b, newdata=newdata4, type="haz", lty=1, col = "green")
lines(fpm_c, newdata=newdata4, type="haz", lty=2, col = "green")
legend("topright", legend=paste0(agegrps), lty=1, col=c("red","blue","purple","green"))
source("~/cansurv_r/solutions/q132.R")
## Exercise 132
## Created: 2021-08-05 Enoch Chen
## Edited:  2021-08-10 Enoch Chen
###############################################################################
## Load the packages
library(biostat3)
library(haven)
library(dplyr)   # manipulate data
library(rstpm2)
library(ggplot2) # ggplot
## Read data
melanoma <- read_dta("melanoma.dta")%>%
filter(stage == 1) %>%
mutate(year8594 = ifelse(year8594 == 1, "Diagnosed 85-94", "Diagnosed 75-84"),
female = ifelse(sex == 2, +1, +0), # Create a female variable
event  = ifelse((status == 1) & surv_mm<= 60.5, 1, 0), # Redefine status
surv_mm = ifelse(surv_mm<= 60.5, surv_mm, 60.5),       # censored everyone after 60 months
t = surv_mm/12,                                     # surv_mm in years
agegrp1 = (agegrp== 0)+0, # used by time-dependent effect
agegrp2 = (agegrp== 1)+0, # used by time-dependent effect
agegrp3 = (agegrp== 2)+0, # used by time-dependent effect
agegrp4 = (agegrp== 3)+0) # used by time-dependent effect
melanoma <- melanoma %>%
mutate(year8594 = as_factor(year8594),
agegrp = as_factor(agegrp))
str(melanoma)
#' status is coded as follows
#' 1 [Dead: cancer]
#' 2 [Dead: other]
#' 0 [Alive]
#' 4 [Lost to follow-up]
#' agegrp is coded as follows
#' 0 [0-44]  -> agegrp1
#' 1 [45-59] -> agegrp2
#' 2 [60-74] -> agegrp3
#' 3 [75+]   -> agegrp4
#' female is coded as follows
#' 0 [Male]
#' 1 [Female]
##(a) fit a Cox model
# Assess the PH assumption for age group
cox_a <- coxph(Surv(t, event) ~ female + year8594 + agegrp2 + agegrp3 + agegrp4, data = melanoma)
summary(cox_a)
##Plot of the scaled Schoenfeld residuals for calendar period 1985–94
cox_a.phtest <- cox.zph(cox_a, transform="identity")
print(cox_a.phtest)
plot(cox_a.phtest[3], resid=TRUE, se=TRUE, main="Test of PH assumption: Schoenfeld residuals")
plot(cox_a.phtest[4], resid=TRUE, se=TRUE, main="Test of PH assumption: Schoenfeld residuals")
plot(cox_a.phtest[5], resid=TRUE, se=TRUE, main="Test of PH assumption: Schoenfeld residuals")
##(b) fit flexible parametric model
fpm_b <- stpm2(Surv(t, event) ~ female + year8594 + agegrp2 + agegrp3 + agegrp4, data = melanoma, df=4)
summary(fpm_b)
eform(fpm_b)
## Hazard function
years <- levels(melanoma$year8594)
agegrps <- levels(melanoma$agegrp)
newdata1 <- data.frame(female=0, year8594=years[1], agegrp2=0, agegrp3=0, agegrp4=0)
newdata2 <- data.frame(female=0, year8594=years[1], agegrp2=1, agegrp3=0, agegrp4=0)
newdata3 <- data.frame(female=0, year8594=years[1], agegrp2=0, agegrp3=1, agegrp4=0)
newdata4 <- data.frame(female=0, year8594=years[1], agegrp2=0, agegrp3=0, agegrp4=1)
plot(fpm_b, newdata=newdata1,
xlab="Time since diagnosis (years)",
ylab="Cause specific mortality rate (per pys)",
type="haz", ci=FALSE, ylim=c(0,0.2))
lines(fpm_b, newdata=newdata2, type="haz", lty=2)
lines(fpm_b, newdata=newdata3, type="haz", lty=3)
lines(fpm_b, newdata=newdata4, type="haz", lty=4)
legend("topright", legend=paste0(agegrps), lty=1:4)
##(c) Time-dependent effects for age group
fpm_c <- stpm2(Surv(t, event) ~ female + year8594 + agegrp2 + agegrp3 + agegrp4,
tvc=list(agegrp2= 2 , agegrp3= 2 , agegrp4 = 2), data = melanoma, df=4)
summary(fpm_c)
eform(fpm_c)
#Likelihood-ratio test
anova(fpm_b, fpm_c)
##(d) predict the hazard for each age group
plot(fpm_b, newdata=newdata1,
xlab="Time since diagnosis (years)",
ylab="Cause specific mortality rate (per pys)",
type="haz", ci=FALSE, ylim=c(0,0.2), line.col = "red")
lines(fpm_c, newdata=newdata1, type="haz", lty=2, col = "red")
lines(fpm_b, newdata=newdata2, type="haz", lty=1, col = "blue")
lines(fpm_c, newdata=newdata2, type="haz", lty=2, col = "blue")
lines(fpm_b, newdata=newdata3, type="haz", lty=1, col = "purple")
lines(fpm_c, newdata=newdata3, type="haz", lty=2, col = "purple")
lines(fpm_b, newdata=newdata4, type="haz", lty=1, col = "green")
lines(fpm_c, newdata=newdata4, type="haz", lty=2, col = "green")
legend("topright", legend=paste0(agegrps), lty=1, col=c("red","blue","purple","green"))
=======
newdata1 <- data.frame(female=0, year8594=years[1], agegrp2=0, agegrp3=0, agegrp4=0)
newdata4 <- data.frame(female=0, year8594=years[1], agegrp2=0, agegrp3=0, agegrp4=1)
## Survival function
plot(ph, newdata=newdata1,
xlab="Time since diagnosis (years)",
ylab="Survival probability",
type="surv", ci=FALSE, ylim=c(0,1))
lines(po, newdata=newdata1, type="surv", col=2)
lines(ph, newdata=newdata4, type="surv", col=3)
lines(po, newdata=newdata4, type="surv", col=4)
legend("bottomright", legend = c("PH agegrp0", "PO agegrp0", "PH agegrp4", "PO agegrp4"),
col = 1:4, lty = 1)
## Hazard function
plot(ph, newdata=newdata1,
xlab="Time since diagnosis (years)",
ylab="Hazard rates",
type="haz", ci=FALSE, ylim=c(0,0.3))
lines(po, newdata=newdata1, type="haz", col=2)
lines(ph, newdata=newdata4, type="haz", col=3)
lines(po, newdata=newdata4, type="haz", col=4)
legend("topright", legend = c("PH agegrp0", "PO agegrp0", "PH agegrp4", "PO agegrp4"),
col = 1:4, lty = 1)
##(d) Compare AIC and BIC
AIC(ph, po)
BIC(ph, po)
##(e) Hazard ratio for female
plot(po, newdata=newdata1,
xlab="Time since diagnosis (years)",
ylab="Hazard ratio",
var="female",
type="hr", ci=TRUE, ylim=c(0.45,0.65))
##(f) Compare hazard ratios for different covariate patterns
plot(po, newdata=newdata1,
xlab="Time since diagnosis (years)",
ylab="Hazard ratio",
var="female",
type="hr", ci=FALSE, ylim=c(0.5,0.7))
lines(po, newdata=newdata4,
var="female",
type="hr", ci=FALSE, col=2)
##(g) Fit Aranda-Ordaz link function
ao <- stpm2(Surv(t, event) ~ female + year8594 + agegrp2 + agegrp3 + agegrp4, data = melanoma, df=4,
link.type = "AO")
summary(ao)
eform(ao)
AIC(ph, po, ao)
BIC(ph, po, ao)
##(h) Show estimate of theta with 95% CI
coefs <- names(coef(po))
linearHypothesis(po,c("female = 0","year8594 = 0"))
library(car)
linearHypothesis(po,c("female = 0","year8594 = 0"))
## (b) Proportional Odds Model
#' g(S)=-logit(S)
po <- stpm2(Surv(t, event) ~ female + year8594 + agegrp2 + agegrp3 + agegrp4, data = melanoma, df=4,
link.type = "PO")
summary(po)
lincom(po, "as.factor(sex)", eform=TRUE)
lincom(po)
lincom(po, female)
lincom(po, "female")
lincom(po, c("female"))
lincom(po, c("po@female"))
lincom(ph, c("female"))
lincom(ph)
View(po)
##(h) Show estimate of theta with 95% CI
coef_po<- exp(coef(po))
coef_po["female"]
?stpm2
##(g) Fit Aranda-Ordaz link function
ao <- stpm2(Surv(t, event) ~ female + year8594 + agegrp2 + agegrp3 + agegrp4, data = melanoma, df=4,
link.type = "AO", theta.AO = 0)
summary(ao)
eform(ao)
AIC(ph, po, ao)
BIC(ph, po, ao)
##(h) Show estimate of theta with 95% CI
coef_po<- exp(coef(po))
coef_po["female"]
>>>>>>> afd334f18890f618ee0957e564f6b540d44957d9
