## Load the packages
library(biostat3)
library(haven)
library(dplyr)   # manipulate data
library(rstpm2)  # nsx
library(ggplot2) # ggplot
## Read data
## All stages
melanoma <- read_dta("melanoma.dta")%>%
filter(stage == 1) %>%
mutate(year8594 = ifelse(year8594 == 1, "Diagnosed 85-94", "Diagnosed 75-84"),
female = ifelse(sex == 2, 1, 0), # Create a female variable
event  = ifelse((status == 1) & surv_mm<= 120.5, 1, 0), # Redefine status
surv_mm = ifelse(surv_mm<= 120.5, surv_mm, 120.5),     # censored everyone after 120 months
t = surv_mm/12,                                     # surv_mm in years
agegrp1 = (agegrp== 1)+0, # used by time-dependent effect
agegrp2 = (agegrp== 2)+0, # used by time-dependent effect
agegrp3 = (agegrp== 3)+0, # used by time-dependent effect
agegrp4 = (agegrp== 4)+0) # used by time-dependent effect
##(b) Weibull model (using stpm2)
fpm_b <- stpm2(Surv(time, event) ~ 1, data = melanoma, df=1)
summary(fpm_b)
eform(fpm_b)
s <- predict(fpm_b,grid=FALSE,full=TRUE,se.fit=FALSE,
type="surv")
ggplot(s, aes(x=time,y=Estimate,ymin=lower,ymax=upper)) +
xlab("analysis time") +
ylab("Survival") +
geom_ribbon(alpha=0.6) +
geom_line()
ggplot(s, aes(x=time,y=Estimate)) +
xlab("analysis time") +
ylab("Survival") +
geom_ribbon(alpha=0.6) +
geom_line()
ggplot(s, aes(x=time,y=Estimate)) +
xlab("analysis time") +
ylab("Survival")
ggplot(s, aes(x=time,y=Estimate)) +
xlab("analysis time") +
ylab("Survival") +
geom_line()
View(s)
## Exercise 131
## Created: 2021-06-21 Enoch Chen
## Edited:  2021-06-21 Enoch Chen
## Reference: Biostatistics III in R. https://biostat3.net/download/R/solutions/q28.html
###############################################################################
## Load the packages
library(biostat3)
library(haven)
library(dplyr)   # manipulate data
library(rstpm2)  # nsx
library(ggplot2) # ggplot
## Read data
## All stages
melanoma <- read_dta("melanoma.dta")%>%
filter(stage == 1) %>%
mutate(year8594 = ifelse(year8594 == 1, "Diagnosed 85-94", "Diagnosed 75-84"),
female = ifelse(sex == 2, 1, 0), # Create a female variable
event  = ifelse((status == 1) & surv_mm<= 120.5, 1, 0), # Redefine status
surv_mm = ifelse(surv_mm<= 120.5, surv_mm, 120.5),     # censored everyone after 120 months
t = surv_mm/12,                                     # surv_mm in years
agegrp1 = (agegrp== 1)+0, # used by time-dependent effect
agegrp2 = (agegrp== 2)+0, # used by time-dependent effect
agegrp3 = (agegrp== 3)+0, # used by time-dependent effect
agegrp4 = (agegrp== 4)+0) # used by time-dependent effect
#' status is coded as follows
#' 1 [Dead: cancer]
#' 2 [Dead: other]
#' 0 [Alive]
#' 4 [Lost to follow-up]
#' agegrp is coded as follows
#' 1 [0-44]
#' 2 [45-59]
#' 3 [60-74]
#' 4 [75+]
#' sex is coded as follows
#' 1 [Male]
#' 2 [Female]
##(a) Kaplan-Meier curve
km <- survfit(Surv(time, event == 1) ~ 1, data = melanoma) # make Kaplan-Meier estimates
summary(km)
plot(km,                                                     # plot Kaplan-Meier curve
ylab = "S(t)",
xlab = "analysis time",
main = "Kaplan−Meier survival estimate")
##(b) Weibull model (using stpm2)
fpm_b <- stpm2(Surv(t, event) ~ 1, data = melanoma, df=1)
summary(fpm_b)
eform(fpm_b)
s <- predict(fpm_b,grid=FALSE,full=TRUE,se.fit=FALSE,
type="surv")
ggplot(s, aes(x=t,y=Estimate)) +
xlab("analysis time") +
ylab("Survival") +
geom_line()
ggplot(s, aes(x=t, y=Estimate, ymin=0.6, ymax=1)) +
xlab("analysis time") +
ylab("Survival") +
geom_line()
km_curve<- plot(km,                                                     # plot Kaplan-Meier curve
ylab = "S(t)",
xlab = "analysis time",
main = "Kaplan−Meier survival estimate")
ggplot(s, aes(x=t, y=Estimate, ymin=0.6, ymax=1)) +
xlab("analysis time") +
ylab("Survival") +
geom_line()+
km_curve
ggplot(s, aes(x=t, y=Estimate, ymin=0.6, ymax=1)) +
xlab("analysis time") +
ylab("Survival") +
geom_line(km_curve)
plot(fpm_b)
ggplot(s, aes(x=t, y=Estimate, ymin=0.6, ymax=1)) +
xlab("analysis time") +
ylab("Survival") +
geom_line()
lines(km_curve)
plot(fpm_b)
##(b) Weibull model (using stpm2)
fpm_b <- stpm2(Surv(t, event) ~ 1, data = melanoma, df=1)
summary(fpm_b)
eform(fpm_b)
s <- predict(fpm_b,grid=FALSE,full=TRUE,se.fit=FALSE,
type="surv")
ggplot(s, aes(x=t, y=Estimate, ymin=0.6, ymax=1)) +
xlab("analysis time") +
ylab("Survival") +
geom_line()
lines(km_curve)
km_curve<- plot(km,                                                     # plot Kaplan-Meier curve
ylab = "S(t)",
xlab = "analysis time",
main = "Kaplan−Meier survival estimate")
lines(fpm_b, data = melanoma)
lines(fpm_b, newdata = melanoma)
## Overlay KM curve with stpm2-Weibull
plot(km,   # plot Kaplan-Meier curve
ylab = "S(t)",
xlab = "analysis time",
ymin = 0.6,
ymax = 1,
main = "Kaplan−Meier survival estimate")
plot(km,   # plot Kaplan-Meier curve
ylab = "S(t)",
xlab = "analysis time",
ymin = 0.6,
ymax = 1,
CI = FALSE,
main = "Kaplan−Meier survival estimate")
lines(fpm_b, newdata = melanoma)
lines(fpm_b, newdata = melanoma, CI= FALSE)
lines(fpm_b, newdata = melanoma, lty =1 )
lines(fpm_b, newdata = melanoma )
warnings()
?lines
s <- predict(fpm_b, grid=FALSE, full=TRUE, se.fit=FALSE, type="surv")
ggplot(s, aes(x=t,y=Estimate)) +
xlab("analysis time") +
ylab("Survival") +
geom_line()
ggplot(s, aes(x=t,y=Estimate, ymin=0.6, ymax=1)) +
xlab("analysis time") +
ylab("Survival") +
geom_line()
ggplot(s, aes(x=t,y=Estimate, ymin=0.6, ymax=1)) +
xlab("analysis time") +
ylab("Survival") +
geom_line()+
ggsurvplot(km, data = melanoma)
library(survival)
ggplot(s, aes(x=t,y=Estimate, ymin=0.6, ymax=1)) +
xlab("analysis time") +
ylab("Survival") +
geom_line()+
ggsurvplot(km, data = melanoma)
require("survival")
install.packages(survival)
install.packages("survival")
install.packages("survival")
install.packages("survival")
install.packages("survival")
install.packages("survival")
library(survival)
library(rstpm2)  # nsx
ggplot(s, aes(x=t,y=Estimate, ymin=0.6, ymax=1)) +
xlab("analysis time") +
ylab("Survival") +
geom_line()+
ggsurvplot(km, data = melanoma)
## Load the packages
library(biostat3)
library(haven)
library(dplyr)   # manipulate data
library(rstpm2)  # nsx
library(ggplot2) # ggplot
library(survival)
ggplot(s, aes(x=t,y=Estimate, ymin=0.6, ymax=1)) +
xlab("analysis time") +
ylab("Survival") +
geom_line()+
ggsurvplot(km, data = melanoma)
ggplot(s, aes(x=t,y=Estimate, ymin=0.6, ymax=1)) +
xlab("analysis time") +
ylab("Survival") +
geom_line()+
ggsurvplot(km, data = melanoma)
ggplot(s, aes(x=t,y=Estimate, ymin=0.6, ymax=1)) +
xlab("analysis time") +
ylab("Survival") +
geom_line()+
survival::ggsurvplot(km, data = melanoma)
ggsurvplot(km, data = melanoma)
survival::ggsurvplot(km, data = melanoma)
library(survival)
library(survival)
install.packages("rstpm2")
install.packages("rstpm2")
library(ggplot2) # ggplot
library(biostat3)
library(haven)
library(dplyr)   # manipulate data
## Read data
melanoma <- read_dta("melanoma.dta")%>%
filter(stage == 1) %>%
mutate(year8594 = ifelse(year8594 == 1, "Diagnosed 85-94", "Diagnosed 75-84"),
female = ifelse(sex == 2, 1, 0), # Create a female variable
event  = ifelse((status == 1) & surv_mm<= 120.5, 1, 0), # Redefine status
surv_mm = ifelse(surv_mm<= 120.5, surv_mm, 120.5),     # censored everyone after 120 months
t = surv_mm/12,                                     # surv_mm in years
agegrp1 = (agegrp== 1)+0, # used by time-dependent effect
agegrp2 = (agegrp== 2)+0, # used by time-dependent effect
agegrp3 = (agegrp== 3)+0, # used by time-dependent effect
agegrp4 = (agegrp== 4)+0) # used by time-dependent effect
#' status is coded as follows
#' 1 [Dead: cancer]
#' 2 [Dead: other]
#' 0 [Alive]
#' 4 [Lost to follow-up]
#' agegrp is coded as follows
#' 1 [0-44]
#' 2 [45-59]
#' 3 [60-74]
#' 4 [75+]
#' sex is coded as follows
#' 1 [Male]
#' 2 [Female]
##(a) Kaplan-Meier curve
km <- survfit(Surv(time, event == 1) ~ 1, data = melanoma) # make Kaplan-Meier estimates
summary(km)
##(a) Kaplan-Meier curve
km <- survfit(Surv(t, event == 1) ~ 1, data = melanoma) # make Kaplan-Meier estimates
summary(km)
plot(km)
# Plot Kaplan-Meier curve
plot(km,
ylab="S(t)",
xlab="analysis time",
main = "Kaplan−Meier survival estimate")
##(b) Weibull model (using stpm2)
fpm_b <- stpm2(Surv(t, event) ~ 1, data = melanoma, df=1)
summary(fpm_b)
eform(fpm_b)
library(rstpm2)  # nsx
fpm_b <- stpm2(Surv(t, event) ~ 1, data = melanoma, df=1)
summary(fpm_b)
eform(fpm_b)
s <- predict(fpm_b, grid=FALSE, full=TRUE, se.fit=FALSE, type="surv")
ggplot(s, aes(x=t,y=Estimate, ymin=0.6, ymax=1)) +
xlab("analysis time") +
ylab("Survival") +
geom_line()
ggsurvplot(km, data = melanoma)
ggsurvplot(km, data = melanoma)
library(survival)
ggsurvplot(km, data = melanoma)
survival::ggsurvplot(km, data = melanoma)
ggsurvplot(km, data = melanoma)
library(survminer)
ggsurvplot(km, data = melanoma)
ggplot(s, aes(x=t,y=Estimate, ymin=0.6, ymax=1)) +
xlab("analysis time") +
ylab("Survival") +
geom_line() +
ggsurvplot(km, data = melanoma)
ggplot(s, aes(x=t,y=Estimate, ymin=0.6, ymax=1)) +
xlab("analysis time") +
ylab("Survival") +
geom_line()
print(ggsurvplot(km, data = melanoma))
kmp <- predict (km)
ggplot(s, aes(x=t,y=Estimate, ymin=0.6, ymax=1)) +
xlab("analysis time") +
ylab("Survival") +
geom_line() +
km
ggplot(s, aes(x=t,y=Estimate, ymin=0.6, ymax=1)) +
xlab("analysis time") +
ylab("Survival") +
geom_line()
plot <- rbind(km, s)
km <- survfit(Surv(t, event == 1) ~ 1, data = melanoma) # make Kaplan-Meier estimates
summary(km)
plot(km,
ylab="S(t)",
xlab="analysis time",
main = "Kaplan−Meier survival estimate")
## Overlay KM curve with stpm2-Weibull
plot(km,
ylab="S(t)",
xlab="analysis time",
main = "Kaplan−Meier survival estimate")
lines(fpm_b, newdata = melanoma)
lines(s, newdata = melanoma)
lines(s, newdata = melanoma)
plot(km,
ylab="S(t)",
xlab="analysis time",
main = "Kaplan−Meier survival estimate")
lines(s, newdata = melanoma)
View(s)
## Overlay KM curve with stpm2-Weibull
plot(km,
ylab="S(t)",
xlab="analysis time",
main = "Kaplan−Meier survival estimate")
lines(s, newdata = s)
## Overlay KM curve with stpm2-Weibull
plot(km,
ylab="S(t)",
xlab="analysis time",
main = "Kaplan−Meier survival estimate")
lines(s, newdata = melanoma)
ggplot(s, aes(x=t,y=Estimate, ymin=0.6, ymax=1)) +
xlab("analysis time") +
ylab("Survival") +
geom_line()
par(new=TRUE)
## Overlay KM curve with stpm2-Weibull
plot(km,
ylab="S(t)",
xlab="analysis time",
main = "Kaplan−Meier survival estimate")
ggplot(s, aes(x=t,y=Estimate, ymin=0.6, ymax=1)) +
xlab("analysis time") +
ylab("Survival") +
geom_line()
par(new=FALSE)
## Overlay KM curve with stpm2-Weibull
plot(km,
ylab="S(t)",
xlab="analysis time",
main = "Kaplan−Meier survival estimate")
View(s)
km_b <-  survfit(Surv(t, event == 1) ~ 1, data = s) # make Kaplan-Meier estimates
plot(km,
ylab="S(t)",
xlab="analysis time",
main = "Kaplan−Meier survival estimate")
lines(s)
plot(km_b,
ylab="S(t)",
xlab="analysis time",
main = "Kaplan−Meier survival estimate")
lines(s)
plot(km_b,
x = t,
ylab="S(t)",
xlab="analysis time",
main = "Kaplan−Meier survival estimate")
lines(t, Esitmate)
plot(km_b,
x = t,
ylab="S(t)",
xlab="analysis time",
main = "Kaplan−Meier survival estimate")
lines(t, Estimate)
km_b <-  survfit(Surv(t, event == 1) ~ 1, data = s) # make Kaplan-Meier estimates
plot(km_b,
x = t,
ylab="S(t)",
xlab="analysis time",
main = "Kaplan−Meier survival estimate")
lines(x= t, y= Estimate)
plot(km_b,
x = t,
ylab="S(t)",
xlab="analysis time",
main = "Kaplan−Meier survival estimate")
lines(x= t, y= Estimate, newdata = s)
plot(km_b,
x = t,
ylab="S(t)",
xlab="analysis time",
main = "Kaplan−Meier survival estimate")
lines(x= t, y= Estimate, newdata = s)
View(s)
View(km)
summary(km)
kmm <- predict(km )
km_b <-  survfit(Surv(t, event == 1) ~ 1, data = s) # make Kaplan-Meier estimates
plot(km,
ylab="S(t)",
xlab="analysis time",
main = "Kaplan−Meier survival estimate")
lines(fpm_b)
lines(fpm_b, newdata = melanoma)
plot(km,
ylab="S(t)",
xlab="analysis time",
main = "Kaplan−Meier survival estimate")
lines(fpm_b, newdata = melanoma)
lines(fpm_b, newdata = melanoma conf.int=FALSE)
# Plot Kaplan-Meier curve
plot(km,
ylab="S(t)",
xlab="analysis time",
main = "Kaplan−Meier survival estimate")
lines(fpm_b, newdata = melanoma, conf.int=FALSE)
lines(fpm_b, conf.int=FALSE, newdata = melanoma)
lines(s, conf.int=FALSE, newdata = melanoma)
# Plot Kaplan-Meier curve
plot(km,
ylab="S(t)",
xlab="analysis time",
main = "Kaplan−Meier survival estimate",
add = TRUE)
ggplot(s, aes(x=t,y=Estimate, ymin=0.6, ymax=1)) +
xlab("analysis time") +
ylab("Survival") +
geom_line()
plot(km,
ylab="S(t)",
xlab="analysis time",
main = "Kaplan−Meier survival estimate",
add = TRUE)
lines(s)
lines(fpm_b, newdata = melanoma)
##(a) Kaplan-Meier curve
km <- survfit(Surv(t, event == 1) ~ 1, data = melanoma) # make Kaplan-Meier estimates
summary(km)
# Plot Kaplan-Meier curve
plot(km,
ylab="S(t)",
xlab="analysis time",
main = "Kaplan−Meier survival estimate",
add = TRUE)
fpm_b <- stpm2(Surv(t, event) ~ 1, data = melanoma, df=1)
summary(fpm_b)
eform(fpm_b)
s <- predict(fpm_b, grid=FALSE, full=TRUE, se.fit=FALSE, type="surv")
ggplot(s, aes(x=t,y=Estimate, ymin=0.6, ymax=1)) +
xlab("analysis time") +
ylab("Survival") +
geom_line()
plot(km,
ylab="S(t)",
xlab="analysis time",
main = "Kaplan−Meier survival estimate",
add = TRUE)
plot(s)
# Plot Kaplan-Meier curve
plot(km,
ylab="S(t)",
xlab="analysis time",
main = "Kaplan−Meier survival estimate",
add = TRUE)
lines(s)
plot(km,
ylab="S(t)",
xlab="analysis time",
main = "Kaplan−Meier survival estimate",
add = TRUE)
lines(s)
plot(km,
ylab="S(t)",
xlab="analysis time",
main = "Kaplan−Meier survival estimate",
add = TRUE)
lines(s$t, Estimate)
View(s)
lines(s$t, s$Estimate)
plot(km,
ylab="S(t)",
xlab="analysis time",
main = "Kaplan−Meier survival estimate",
add = TRUE)
lines(s$t, s$Estimate)
# Plot Kaplan-Meier curve
plot(km,
ylab="S(t)",
xlab="analysis time",
main = "Kaplan−Meier survival estimate")
lines(s$t, s$Estimate)
plot(km,
ylab="S(t)",
xlab="analysis time",
main = "Kaplan−Meier survival estimate")
lines(s$t, s$Estimate, type = "s")
plot(km,
ylab="S(t)",
xlab="analysis time",
main = "Kaplan−Meier survival estimate")
lines(s$t, s$Estimate)
plot(km,
ylab="S(t)",
xlab="analysis time",
main = "Kaplan−Meier survival estimate")
lines(s$t, s$Estimate, lwd = 1)
source('~/cansurv_r/solutions/q131.R', echo=TRUE)
