melanoma_10y_spl3 <- survSplit(Surv(surv_mm, status == 1)~., data=melanoma_10y,
cut=cuts.splines, start="tstart", end="tstop") %>%
mutate(cut = cut(tstop, cuts.splines),
mid = mid.splines[unclass(cut)]) %>%
group_by(mid, year8594, sex, agegrp) %>%
summarise(pt = sum(tstop-tstart), status = sum("status"))
melanoma_10y_spl3 <- survSplit(Surv(surv_mm, status == 1)~., data=melanoma_10y,
cut=cuts.splines, start="tstart", end="tstop") %>%
mutate(cut = cut(tstop, cuts.splines),
mid = mid.splines[unclass(cut)]) %>%
group_by(mid, year8594, sex, agegrp) %>%
summarise(pt = sum(tstop-tstart), status = sum(status))
View(melanoma_10y_spl3)
melanoma_10y_spl3 <- survSplit(Surv(surv_mm, status == 1)~., data=melanoma_10y,
cut=cuts.splines, start="tstart", end="tstop") %>%
mutate(cut = cut(tstop, cuts.splines),
mid = mid.splines[unclass(cut)]) %>%
group_by(mid, year8594, sex, agegrp) %>%
summarise(pt = sum(tstop-tstart), status = sum(event))
melanoma_10y_spl3 <- survSplit(Surv(surv_mm, status == 1)~., data=melanoma_10y,
cut=cuts.splines, start="tstart", end="tstop") %>%
mutate(cut = cut(tstop, cuts.splines),
mid = mid.splines[unclass(cut)]) %>%
group_by(mid, year8594, sex, agegrp) %>%
summarise(pt = sum(tstop-tstart), status = event)
poisson_h <- glm( status == 1 ~ ns(mid, df=3) + year8594 + sex + agegrp + offset( log(pt) ),
family = poisson,
data = melanoma_10y_spl3 )
summary(poisson_h)
eform(poisson_h)
## Date: 2015-03-03
## Purpose: To do the solution for Biostat III exercise 9 in R
## Author: Annika Tillander,  Johan Zetterqvist
###############################################################################
## ## Install needed packages only need to be done once
## Install needed packages only need to be done once
## install.packages("foreign")
## install.packages("muhaz")
## install.packages("car")
###############################################################################
## Exercise 9
###############################################################################
## @knitr loadDependencies
library(biostat3)
library(dplyr)    # for data manipulation
library(splines)   # ns (recommended package)
## @knitr loadPreprocess
## Read melanoma data, select subcohorts and create a death indicator
melanoma.l <- biostat3::melanoma %>%
filter(stage=="Localised") %>%
mutate(death_cancer = as.numeric(status=="Dead: cancer"))
melanoma.l2 <-    mutate(melanoma.l,
## Create a death indicator (only count deaths within 120 months)
death_cancer = death_cancer * as.numeric( surv_mm <= 120),
## Create a new time variable
surv_mm = pmin(surv_mm, 120))
## @knitr 9.a
summary( coxfit9a <- coxph(Surv(surv_mm, death_cancer) ~ year8594,
data = melanoma.l2) )
## @knitr 9.b
survdiff(Surv(surv_mm, death_cancer) ~ year8594, data = melanoma.l)
summary( coxfit9b <- coxph(Surv(surv_mm, death_cancer) ~ year8594,
data = melanoma.l) )
## @knitr 9.c
summary( coxfit9c <- coxph(Surv(surv_mm, death_cancer) ~ year8594 + sex + agegrp,
data = melanoma.l2) )
## Test if the effect of age is significant
## Use a Wald test with the car package
library(car)
linearHypothesis(coxfit9c,c("agegrp45-59 = 0","agegrp60-74 = 0","agegrp75+ = 0"))
## @knitr 9.d
## Test if the effect of age is significant
## Use an LR test with the anova function
## The model without agegrp
summary( coxfit9d <- coxph(Surv(surv_mm, death_cancer) ~ year8594 + sex,
data = melanoma.l2) )
## LR test
anova(coxfit9c, coxfit9d)
anova(coxfit9c)
## @knitr 9.e
summary( coxfit9e <- coxph(Surv(surv_mm, death_cancer) ~ year8594 + sex + agegrp,
data = melanoma.l2) )
## Split follow up by year
melanoma.spl <- survSplit(melanoma.l2, cut=12*(0:10), end="surv_mm", start="start",
event="death_cancer")
## Calculate persontime and
## recode start time as a factor
melanoma.spl <- mutate(melanoma.spl,
pt = surv_mm - start,
fu = as.factor(start) )
## Run Poisson regression
summary(poisson9e <- glm( death_cancer ~ fu + year8594 + sex + agegrp + offset( log(pt) ),
family = poisson,
data = melanoma.spl ))
eform(poisson9e)
summary(coxfit9e)
## @knitr 9.f
sfit9f <- survfit(Surv(surv_mm, event=death_cancer) ~ 1,
data = melanoma.l2 )
## Have a look at the fitted object
str(sfit9f, 1)
head(sfit9f$time)
## Split follow up by event times
melanoma.spl2 <- survSplit(melanoma.l2, cut=sfit9f$time, end="surv_mm", start="start",
event="death_cancer")
## Calculate persontime and
## recode start time as a factor
melanoma.spl2 <- mutate(melanoma.spl2,
pt = surv_mm - start,
fu = as.factor(start) )
## Collapse
melanoma.spl3 <- melanoma.spl2 %>%
group_by(fu,year8594,sex,agegrp) %>%
summarise(pt=sum(pt), death_cancer=sum(death_cancer)) %>%
data.frame
## Run Poisson regression
poisson9f <- glm( death_cancer ~ fu + year8594 + sex + agegrp + offset( log(pt) ),
family = poisson,
data = melanoma.spl3 )
## IRR
coef9f <- eform(poisson9f)
## We are not interested in nuisance parameters fu1, fu2, etc
npar <- nrow(coef9f)
pars <- (npar-4):npar
coef9f[pars,]
summary(coxfit9e)
cuts.splines <- seq(0,max(sfit9f$time),by=3)
mid.splines <- cuts.splines + 1.5
melanoma.spl4 <-
survSplit(Surv(surv_mm,death_cancer)~., data=melanoma.l2, cut=cuts.splines,
start="tstart", end="tstop") %>%
mutate(cut=cut(tstop,cuts.splines),
mid=mid.splines[unclass(cut)]) %>%
group_by(mid,year8594,sex,agegrp)
View(melanoma.spl4)
melanoma_10y_spl3 <- survSplit(Surv(surv_mm, status == 1)~., data=melanoma_10y,
cut=cuts.splines, start="tstart", end="tstop") %>%
mutate(cut = cut(tstop, cuts.splines),
mid = mid.splines[unclass(cut)]) %>%
group_by(mid, year8594, sex, agegrp)
View(melanoma.spl3)
View(melanoma_10y_spl3)
melanoma.spl4 <-
survSplit(Surv(surv_mm,death_cancer)~., data=melanoma.l2, cut=cuts.splines,
start="tstart", end="tstop") %>%
mutate(cut=cut(tstop,cuts.splines),
mid=mid.splines[unclass(cut)]) %>%
group_by(mid,year8594,sex,agegrp) %>%
summarise(pt=sum(tstop-tstart), death_cancer=sum(death_cancer))
View(melanoma.spl4)
melanoma_10y_spl3 <- survSplit(Surv(surv_mm, status == 1)~., data=melanoma_10y,
cut=cuts.splines, start="tstart", end="tstop") %>%
mutate(cut = cut(tstop, cuts.splines),
mid = mid.splines[unclass(cut)]) %>%
group_by(mid, year8594, sex, agegrp) %>%
summarise(pt = sum(tstop-tstart), status = sum(event))
poisson_h <- glm( status ~ ns(mid, df=3) + year8594 + sex + agegrp + offset( log(pt) ),
family = poisson,
data = melanoma_10y_spl3 )
summary(poisson_h)
eform(poisson_h)
library(effects)
plot(Effect("mid", poisson_h))
install.packages("effects")
library(effects)
plot(Effect("mid", poisson_h))
polygon.ci <- function(time, interval, col="lightgrey")
polygon(c(time,rev(time)),
c(interval[,1],rev(interval[,2])),
col=col, border=col)
## Define exposures
times <- seq(0,max(cuts.splines),length=1000)
delta <- diff(times)[1]
newdata <- data.frame(mid=times+delta/2, year8594="Diagnosed 85-94",
sex="Male", agegrp="45-59",
pt=1)
## Predict rates and 95% CI
pred <- predict(poisson_h, newdata=newdata, se.fit=TRUE)
predrate <- exp(pred$fit)
ci <- with(pred, exp(cbind(fit-1.96*se.fit, fit+1.96*se.fit)))
##Plot
matplot(newdata$mid, ci, type="n", xlab="Time since diagnosis (months)",
ylab="Rate", main="Males aged 45-59 years diagnosed 1985-94")
polygon.ci(newdata$mid, ci)
lines(newdata$mid, predrate)
newdata <- data.frame(mid=times+delta/2, year8594="Diagnosed 85-94",
sex="1", agegrp="2", # Male, agegrp 45-59
pt=1)
## Predict rates and 95% CI
pred <- predict(poisson_h, newdata=newdata, se.fit=TRUE)
predrate <- exp(pred$fit)
ci <- with(pred, exp(cbind(fit-1.96*se.fit, fit+1.96*se.fit)))
##Plot
matplot(newdata$mid, ci, type="n", xlab="Time since diagnosis (months)",
ylab="Rate", main="Males aged 45-59 years diagnosed 1985-94")
polygon.ci(newdata$mid, ci)
lines(newdata$mid, predrate)
## Predict survival with 95% CI
library(rstpm2)
logcumhaz <- rstpm2::predictnl(poisson_h,
fun=function(fit,newdata) log(cumsum(delta*predict(fit, newdata, type="response"))),
newdata=newdata)
surv <- exp(-exp(logcumhaz$Estimate))
ci <- with(logcumhaz, exp(-exp(cbind(Estimate-1.96*SE, Estimate+1.96*SE))))
## Plot
matplot(newdata$mid, ci, type="n", xlab="Time since diagnosis (months)",
ylab="Survival", main="Males aged 45-59 years diagnosed 1985-94")
polygon.ci(newdata$mid, ci)
lines(newdata$mid, surv)
source('~/cansurv_r/solutions/q120.R', echo=TRUE)
eform(poisson_e)
poisson_e <- glm( status == 1 ~ fu + year8594 + sex + agegrp + offset(log(pt)),
family=poisson,
data=melanoma_10y_spl)
eform(poisson_e)
summary(poisson_e)
eform(poisson_e)
eform(poisson_e)
eform(poisson_e)
source('~/cansurv_r/solutions/q120.R', echo=TRUE)
poisson_e <- glm( status == 1 ~ fu + year8594 + sex + agegrp + offset(log(pt)),
family=poisson,
data=melanoma_10y_spl)
summary(poisson_e)
eform(poisson_e)
eform(poisson_e)
eform(poisson_e)
eform(poisson_e)
poisson_e <- glm( status == 1 ~ fu + year8594 + sex + agegrp + offset(log(pt)),
family=poisson,
data=melanoma_10y_spl)
eform(poisson_e)
source('~/cansurv_r/solutions/q120.R', echo=TRUE)
##Plot
matplot(newdata$mid, ci, type="n", xlab="Time since diagnosis (months)",
ylab="Rate", main="Males aged 45-59 years diagnosed 1985-94")
polygon.ci(newdata$mid, ci)
lines(newdata$mid, predrate)
##Plot
matplot(newdata$mid, ci, type="n", xlab="Time since diagnosis (months)",
ylab="Rate", main="Males aged 45-59 years diagnosed 1985-94")
polygon.ci(newdata$mid, ci)
lines(newdata$mid, predrate)
polygon.ci <- function(time, interval, col="lightgrey")
polygon(c(time,rev(time)),
c(interval[,1],rev(interval[,2])),
col=col, border=col)
## Define exposures
times <- seq(0,max(cuts.splines),length=1000)
delta <- diff(times)[1]
newdata <- data.frame(mid=times+delta/2, year8594="Diagnosed 85-94",
sex="1", agegrp="2", # Male, agegrp 45-59
pt=1)
pred <- predict(poisson_h, newdata=newdata, se.fit=TRUE)
predrate <- exp(pred$fit)
ci <- with(pred, exp(cbind(fit-1.96*se.fit, fit+1.96*se.fit)))
library(effects)
plot(Effect("mid", poisson_h))
polygon.ci <- function(time, interval, col="lightgrey")
polygon(c(time,rev(time)),
c(interval[,1],rev(interval[,2])),
col=col, border=col)
## Define exposures
times <- seq(0,max(cuts.splines),length=1000)
delta <- diff(times)[1]
newdata <- data.frame(mid=times+delta/2, year8594="Diagnosed 85-94",
sex="1", agegrp="2", # Male, agegrp 45-59
pt=1)
## Predict rates and 95% CI
pred <- predict(poisson_h, newdata=newdata, se.fit=TRUE)
predrate <- exp(pred$fit)
ci <- with(pred, exp(cbind(fit-1.96*se.fit, fit+1.96*se.fit)))
##Plot
matplot(newdata$mid, ci, type="n", xlab="Time since diagnosis (months)",
ylab="Rate", main="Males aged 45-59 years diagnosed 1985-94")
polygon.ci(newdata$mid, ci)
lines(newdata$mid, predrate)
## Slow approach do it step by step
## Utility function to draw a confidence interval
polygon.ci <- function(time, interval, col="lightgrey")
polygon(c(time,rev(time)),
c(interval[,1],rev(interval[,2])),
col=col, border=col)
## Define exposures
times <- seq(0,max(cuts.splines),length=1000)
delta <- diff(times)[1]
newdata <- data.frame(mid=times+delta/2, year8594="Diagnosed 85-94",
sex="1", agegrp="2", # Male, agegrp 45-59
pt=1)
## Predict rates and 95% CI
pred <- predict(poisson_h, newdata=newdata, se.fit=TRUE)
predrate <- exp(pred$fit)
ci <- with(pred, exp(cbind(fit-1.96*se.fit, fit+1.96*se.fit)))
##Plot
matplot(newdata$mid, ci, type="n", xlab="Time since diagnosis (months)",
ylab="Rate", main="Males aged 45-59 years diagnosed 1985-94")
polygon.ci(newdata$mid, ci)
lines(newdata$mid, predrate)
## Slow approach do it step by step
## Utility function to draw a confidence interval
polygon.ci <- function(time, interval, col="lightgrey")
polygon(c(time,rev(time)),
c(interval[,1],rev(interval[,2])),
col=col, border=col)
## Define exposures
times <- seq(0,max(cuts.splines),length=1000)
delta <- diff(times)[1]
newdata <- data.frame(mid=times+delta/2, year8594="Diagnosed 85-94",
sex="1", agegrp="2", # Male, agegrp 45-59
pt=1)
## Predict rates and 95% CI
pred <- predict(poisson_h, newdata=newdata, se.fit=TRUE)
predrate <- exp(pred$fit)
ci <- with(pred, exp(cbind(fit-1.96*se.fit, fit+1.96*se.fit)))
##Plot
matplot(newdata$mid, ci, type="n", xlab="Time since diagnosis (months)",
ylab="Rate", main="Males aged 45-59 years diagnosed 1985-94")
polygon.ci(newdata$mid, ci)
lines(newdata$mid, predrate)
## Split the time scale by 3 months
cuts.splines <- seq(0, max(fit_g$time), by=3)
mid.splines <- cuts.splines + 1.5
melanoma_10y_spl3 <- survSplit(Surv(surv_mm, status == 1)~., data=melanoma_10y,
cut=cuts.splines, start="tstart", end="tstop") %>%
mutate(cut = cut(tstop, cuts.splines),
mid = mid.splines[unclass(cut)]) %>%
group_by(mid, year8594, sex, agegrp) %>%
summarise(pt = sum(tstop-tstart), status = sum(event))
poisson_h <- glm( status ~ ns(mid, df=3) + year8594 + sex + agegrp + offset( log(pt) ),
family = poisson,
data = melanoma_10y_spl3 )
summary(poisson_h)
eform(poisson_h)
library(effects)
plot(Effect("mid", poisson_h))
library(effects)
plot(Effect("mid", poisson_h))
matplot(newdata$mid, ci, type="n", xlab="Time since diagnosis (months)",
ylab="Rate", main="Males aged 45-59 years diagnosed 1985-94")
polygon.ci(newdata$mid, ci)
lines(newdata$mid, fit)
lines(newdata$mid, pred$fit)
lines(newdata$mid, pred$fit)
matplot(newdata$mid, ci, type="n", xlab="Time since diagnosis (months)",
ylab="Rate", main="Males aged 45-59 years diagnosed 1985-94")
polygon.ci(newdata$mid, ci)
lines(newdata$mid, pred$fit)
pred <- predict(poisson_h, newdata=newdata, se.fit=TRUE)
predrate <- exp(pred$fit)
ci <- with(pred, exp(cbind(fit-1.96*se.fit, fit+1.96*se.fit)))
matplot(pred$fit)
matplot(newdata$mid, ci, type="n", xlab="Time since diagnosis (months)",
ylab="Rate", main="Males aged 45-59 years diagnosed 1985-94")
lines(newdata$mid, pred$fit)
matplot(newdata$mid, type="n", xlab="Time since diagnosis (months)",
ylab="Rate", main="Males aged 45-59 years diagnosed 1985-94")
lines(newdata$mid, pred$fit)
matplot(newdata$mid, c(-7,-5), type="n", xlab="Time since diagnosis (months)",
ylab="Rate", main="Males aged 45-59 years diagnosed 1985-94")
pred <- predict(poisson_h, newdata=newdata, se.fit=TRUE)
predrate <- exp(pred$fit)
ci <- with(pred, exp(cbind(fit-1.96*se.fit, fit+1.96*se.fit)))
##Plot
matplot(newdata$mid, ci, type="n", xlab="Time since diagnosis (months)",
ylab="Rate", main="Males aged 45-59 years diagnosed 1985-94")
polygon.ci(newdata$mid, ci)
lines(newdata$mid, predrate)
source('~/cansurv_r/solutions/q120.R', echo=TRUE)
source('~/cansurv_r/solutions/q120.R', echo=TRUE)
## Exercise 121
## Created: 2021-03-30 Enoch Chen
## Edited:  2021-03-30 Enoch Chen
## Reference: Biostatistics III in R. https://biostat3.net/download/R/solutions/q10.html
###############################################################################
## Load the packages
library(biostat3)
library(haven)
library(dplyr)   # manipulate data
#library(splines) # natural splines
#library(car)     # linearHypothesis
## Read data
## subset of stage 1
melanoma <- read_dta("melanoma.dta")%>%
filter(stage == 1)%>%
mutate(year8594 = ifelse(year8594 == 1, "Diagnosed 85-94", "Diagnosed 75-84"),
agegrp = as.factor(agegrp),
sex = as.factor(sex))
#' status is coded as follows
#' 1 [Dead: cancer]
#' 2 [Dead: other]
#' 0 [Alive]
#' 4 [Lost to follow-up]
#' agegrp is coded as follows
#' 1 [0-44]
#' 2 [45-59]
#' 3 [60-74]
#' 4 [75+]
#' sex is coded as follows
#' 1 [Male]
#' 2 [Female]
# Restrict follow-up to 10 years
melanoma_10y <- mutate(melanoma,
status= ifelse(surv_mm <= 120 & status == 1, 1, 0),
surv_mm = ifelse(surv_mm<=120, surv_mm, 120), # censored everyone after 120 months
surv_yy = survmm/12,
)
melanoma_10y <- mutate(melanoma,
status= ifelse(surv_mm <= 120 & status == 1, 1, 0),
surv_mm = ifelse(surv_mm<=120, surv_mm, 120), # censored everyone after 120 months
surv_yy = surv_mm/12,
)
head(melanoma_10y)
head(melanoma_10y:surv_yy)
head(melanoma_10y$surv_yy)
haz_a <- muhaz2(Surv(surv_yy, status == 1) ~ year8594, data = melanoma_10y)
haz_a_df <- as.data.frame(haz_a)
## Plot hazard
plot(haz_a, haz.scale=1000,
xlab="Time since diagnosis (years)",
ylab="Hazard per 1000 person-years")
plot(haz_a, haz.scale=1000,
xlab="Time since diagnosis (years)",
ylab="Hazard per 1000 person-years")
## Alternative: ggplot2
ggplot(haz_a_df, aes(x=x, y=y*1000, colour= strata)) + geom_line() +
xlab("Time since diagnosis (years)") +
ylab("Hazard per 1000 person-years")
library(ggplot2)
ggplot(haz_a_df, aes(x=x, y=y*1000, colour= strata)) + geom_line() +
xlab("Time since diagnosis (years)") +
ylab("Hazard per 1000 person-years")
plot(haz_a, log="y")
survfit_c <- survfit(Surv(surv_yy, status == 1) ~ year8594, data=melanoma_10y)
plot(survfit_c, col=1:2, fun=function(S) - log(-log(S)), log="x",
xlab="log(time)", ylab="-log(H)")
legend("topright",legend=levels(melanoma_10y$year8594),col=1:2,lty=1)
legend("topright",legend=levels(as.factor(melanoma_10y$year8594)),col=1:2,lty=1)
biostat3::survPHplot(Surv(surv_yy, death_cancer) ~ year8594, data=melanoma_10y)
biostat3::survPHplot(Surv(surv_yy, status == 1) ~ year8594, data=melanoma_10y)
##(d) Cox regression
cox_d <- coxph(Surv(surv_yy, status == 1) ~ year8594, data=melanoma_10y)
summary(cox_d)
##(e) Cox regression adjusted for sex, calendar period and age
cox_e <- coxph(Surv(surv_yy, status == 1) ~ sex + year8594 + agegrp, data=melanoma_10y)
summary(cox_e)
cox_e.phtest <- cox.zph(cox_e, transform="identity")
plot(cox2.phtest[2], resid=TRUE, se=TRUE, main="Schoenfeld residuals", ylim=c(-4,4))
cox_e.phtest <- cox.zph(cox_e, transform="identity")
plot(cox_e.phtest[2], resid=TRUE, se=TRUE, main="Schoenfeld residuals", ylim=c(-4,4))
plot(cox_e.phtest[2], resid=TRUE, se=TRUE, main="Test of PH assumption: Schoenfeld residuals", ylim=c(-4,4))
haz_f <- muhaz2(Surv(surv_yy, status == 1) ~ agegrp, data = melanoma_10y)
haz_f_df <- as.data.frame(haz_f)
plot(haz_f, haz.scale=1000,
xlab="Time since diagnosis (years)",
ylab="Hazard per 1000 person-years")
ggplot(haz_f_df, aes(x=x, y=y*1000, colour= strata)) + geom_line() +
xlab("Time since diagnosis (years)") +
ylab("Hazard per 1000 person-years")
plot(haz_f, log="y")
survfit_f <- survfit(Surv(surv_yy, status == 1) ~ agegrp, data=melanoma_10y)
plot(survfit_f, col=1:2, fun=function(S) - log(-log(S)), log="x",
xlab="log(time)", ylab="-log(H)")
survfit_f <- survfit(Surv(surv_yy, status == 1) ~ agegrp, data=melanoma_10y)
plot(survfit_f, col=1:4, fun=function(S) - log(-log(S)), log="x",
xlab="log(time)", ylab="-log(H)")
survfit_f <- survfit(Surv(surv_yy, status == 1) ~ agegrp, data=melanoma_10y)
plot(survfit_f, col=1:4, fun=function(S) - log(-log(S)), log="x",
xlab="log(time)", ylab="-log(H)")
legend()
legend(levels(melanoma_10y$agegrp))
plot(survfit_f, col=1:4, fun=function(S) - log(-log(S)), log="x",
xlab="log(time)", ylab="-log(H)", legend(levels(melanoma_10y$agegrp)))
plot(survfit_f, col=1:4, fun=function(S) - log(-log(S)), log="x",
xlab="log(time)", ylab="-log(H)", legend = levels(melanoma_10y$agegrp)))
plot(survfit_f, col=1:4, fun=function(S) - log(-log(S)), log="x",
xlab="log(time)", ylab="-log(H)", legend = levels(melanoma_10y$agegrp))
legend("topright",legend=levels(localised$agegrp),col=1:4,lty=1)
plot(survfit_f, col=1:4, fun=function(S) - log(-log(S)), log="x",
xlab="log(time)", ylab="-log(H)")
legend("topright",legend=levels(localised$agegrp),col=1:4,lty=1)
legend("topright",legend=levels(melanoma_10y$agegrp),col=1:4,lty=1)
legend("topright",legend=levels(as.factor(melanoma_10y$agegrp)),col=1:4,lty=1)
biostat3::survPHplot(Surv(surv_yy, status == 1) ~ agegrp, data=melanoma_10y)
survPHplot
cox_f <- coxph(Surv(surv_yy, status == 1) ~ agegrp, data=melanoma_10y)
summary(cox_f)
cox_f <- coxph(Surv(surv_yy, status == 1) ~ sex + year8594 + agegrp, data=melanoma_10y)
summary(cox_f)
##Plot of the scaled Schoenfeld residuals for calendar period 1985–94
cox_f.phtest <- cox.zph(cox_f, transform="identity")
plot(cox_f.phtest[2], resid=TRUE, se=TRUE, main="Test of PH assumption: Schoenfeld residuals", ylim=c(-4,4))
plot(cox_f.phtest[3], resid=TRUE, se=TRUE, main="Test of PH assumption: Schoenfeld residuals", ylim=c(-4,4))
plot(cox_f.phtest[4], resid=TRUE, se=TRUE, main="Test of PH assumption: Schoenfeld residuals", ylim=c(-4,4))
plot(cox_f.phtest[1], resid=TRUE, se=TRUE, main="Test of PH assumption: Schoenfeld residuals", ylim=c(-4,4))
cox_f.phtest <- cox.zph(cox_f, transform="identity")
print(cox_f.phtest)
## (h) Alternative 1: Cox regression using time-dependent option
melanoma_10y_spl <- survSplit(melanoma_10y, cut=c(2), end="surv_yy", start="start",
event="status", episode="fu") %>%
mutate(fu = as.factor(fu))
##Tabulate ageband including risk_time
melanoma_10y_spl %>% select(id, start, surv_yy) %>% filter(id<=3) %>% arrange(id, surv_yy)
##Alternative 1: Cox regression using time-dependent option
cox_h <- coxph(Surv(start, surv_yy, status == 1) ~ sex + year8594 + agegrp*fu, data=melanoma_10y_spl)
summary(cox_h)
cox_h2 <- coxph(Surv(start, surv_yy, status == 1) ~ sex + year8594 + agegrp + I(agegrp==3 & fu=="2"), data=melanoma_10y_spl)
summary(cox_h2)
melanoma_10y_spl %>% select(id, start, surv_yy) %>% filter(id<=3) %>% arrange(id, surv_yy)
cox_h <- coxph(Surv(start, surv_yy, status == 1) ~ sex + year8594 + agegrp*fu, data=melanoma_10y_spl)
summary(cox_h)
melanoma_10y_spl %>% select(id, start, surv_yy) %>% filter(id<=3) %>% arrange(id, surv_yy)
source('~/cansurv_r/solutions/q121.R', echo=TRUE)
