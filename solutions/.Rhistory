family=poisson, data=melanoma_10y_spl )
poisson_j <- glm( status == 1 ~ fu + agegrp + year8594*sex + offset( log(pt) ),
family=poisson, data=melanoma_10y_spl )
summary(poisson_j)
eform(poisson_j)
##(k) Calculate effect of sex for year8594==2
hr_k <- exp(coef(poisson_j))
hr_k["sex2"]
hr_k <- exp(coef(poisson_j))
hr_k["sex2"]
# Explanation: The effect of sex for patients diagnosed 1975–84 is 0.6031338
hr_k["sex2"]*hr_k["year8594Diagnosed 85-94:sex2"]
# Explanation: The effect of sex for patients diagnosed 1985–94 is 0.6031338
source('~/cansurv_r/solutions/q111.R', echo=TRUE)
source('~/cansurv_r/solutions/q111.R', echo=TRUE)
source('~/cansurv_r/solutions/q111.R', echo=TRUE)
##(k)-ii. Get the estimated effect for patients diagnosed 1985–94 using lincom
biostat3::lincom(poisson_j,c("sex2 + year8594Diagnosed 85-94:sex2"), eform=TRUE)
melanoma_10y_spl <- melanoma_10y_spl %>%
mutate(sex_early = sex==2 & year8594=="Diagnosed 75-84",
sex_latter = sex==2 & year8594=="Diagnosed 85-94")
poisson_k <- glm( status == 1 ~ fu + agegrp + year8594 + sex_early +
sex_latter + offset( log(pt) ),
family=poisson,
data=melanoma_10y_spl )
summary(poisson_k)
eform(poisson_k)
melanoma_10y_spl <- melanoma_10y_spl %>%
mutate(sex_early = sex==2 & year8594=="Diagnosed 75-84",
sex_latter = sex==2 & year8594=="Diagnosed 85-94")
poisson_k <- glm( status == 1 ~ fu + agegrp + year8594 + sex_early +
sex_latter + offset( log(pt) ),
family=poisson,
data=melanoma_10y_spl )
summary(poisson_k)
eform(poisson_k)
##(k)-iv. Add interaction term
poisson_k2 <- glm( status == 1 ~ fu + agegrp + year8594 +
sex:year8594 + offset( log(pt) ),
family=poisson,
data=melanoma_10y_spl )
summary(poisson_k2)
eform(poisson_k2)
poisson_l_early <- glm( status == 1 ~ fu + agegrp + sex + offset( log(pt) ),
family = poisson, data = melanoma_10y_spl,
subset = year8594 == "Diagnosed 75-84" )
summary(poisson_l_early)
eform(poisson_l_early)
poisson_l_later <- glm( status == 1 ~ fu + agegrp + sex + offset( log(pt) ),
family = poisson, data = melanoma_10y_spl,
subset = year8594 == "Diagnosed 85-94" )
summary(poisson_l_later)
eform(poisson_l_later)
poisson_l2 <- glm( status == 1 ~ fu + fu:year8594 + agegrp + agegrp:year8594
+ sex*year8594 + offset( log(pt) ),
family=poisson, data=melanoma_10y_spl )
summary(poisson_l2)
eform(poisson_l2)
source('~/cansurv_r/solutions/q111.R', echo=TRUE)
## Exercise 112
## Created: 2021-03-22 Enoch Chen
## Edited:  2021-03-22 Enoch Chen
## Reference: Biostatistics III in R. https://biostat3.net/download/R/solutions/q8.html
###############################################################################
## Load the packages
library(biostat3)
library(haven)
library(dplyr) # manipulate data
library(bshazard)  # for bshazard
## Read data
diet <- read_dta("diet.dta")
## Check the loaded data
head(diet)
install.packages("bshazard")
## Load the packages
library(biostat3)
library(haven)
library(dplyr) # manipulate data
library(bshazard)  # for bshazard
??bshazard
scale <- 365.24
plot(bshazard(Surv((doe - dob)/scale, (dox - dob)/scale, chd) ~ 1,
data=subset(diet,hieng=="low")),
ylim=c(0,0.03), conf.int=FALSE, xlab="Attained age (years)")
library(bshazard)  # for nonparametric smoothing of hazard function
install.packages("Epi")
library(bshazard)  # for nonparametric smoothing of hazard function
scale <- 365.24
plot(bshazard(Surv((doe - dob)/scale, (dox - dob)/scale, chd) ~ 1,
data=subset(diet,hieng=="low")),
ylim=c(0,0.03), conf.int=FALSE, xlab="Attained age (years)")
library(bshazard)  # for nonparametric smoothing of hazard function
##(a) Incidence rates by attained age
scale <- 365.24
plot(bshazard(Surv((doe - dob)/scale, (dox - dob)/scale, chd) ~ 1,
data=subset(diet,hieng=="low")),
ylim=c(0,0.03), conf.int=FALSE, xlab="Attained age (years)")
fit_a <- Surv((doe - dob)/scale, (dox - dob)/scale, chd) ~ 1,
data=subset(diet, hieng=="low"))
View(diet)
fit_a <- Surv((doe - dob)/scale, (dox - dob)/scale, chd) ~ 1,
data=subset(diet, hieng== 0 )
fit_a <- Surv((doe - dob)/scale, (dox - dob)/scale, chd) ~ 1,
data=subset(diet, hieng== "0")
scale <- 365.24
plot(bshazard(Surv((doe - dob)/scale, (dox - dob)/scale, chd) ~ 1,
data=subset(diet,hieng=="0")),
ylim=c(0,0.03), conf.int=FALSE, xlab="Attained age (years)")
rlang::last_error()
class(diet:doe)
class(diet$doe)
plot(bshazard(Surv((doe - dob)/scale, (dox - dob)/scale, chd) ~ 1,
data=subset(diet,hieng=="0")),
ylim=c(0,0.03), conf.int=FALSE, xlab="Attained age (years)")
plot(bshazard(Surv((doe - dob)/scale, (dox - dob)/scale, chd) ~ 1,
data=subset(diet,hieng ="0")),
ylim=c(0,0.03), conf.int=FALSE, xlab="Attained age (years)")
lines(bshazard(Surv((doe - dob)/scale, (dox - dob)/scale, chd) ~ 1,
data=subset(diet,hieng = "1")),
col="red", conf.int=FALSE)
plot(bshazard(Surv((doe - dob)/scale, (dox - dob)/scale, chd) ~ 1,
data=subset(diet,hieng = "0")),
ylim=c(0,0.03), conf.int=FALSE, xlab="Attained age (years)")
lines(bshazard(Surv((doe - dob)/scale, (dox - dob)/scale, chd) ~ 1,
data=subset(diet,hieng = "1")),
col="red", conf.int=FALSE)
class(diet$hieng)
diet <- transform(diet, ifelse(hieng = "0", "low", "high"))
diet <- read_dta("diet.dta")
#' hieng is coded as follows
#' 0 [low]
#' 1 [high]
diet <- transform(diet, ifelse(hieng == "0", "low", "high"))
diet <- transform(diet, ifelse(hieng == "0", "low", "high"))
diet <- transform(diet, hieng = ifelse(hieng == "0", "low", "high"))
diet <- transform(diet, hieng = ifelse(hieng = "0", "low", "high"))
diet <- transform(diet, hieng = ifelse(hieng == "0", "low", "high"))
diet <- mutate(diet, hieng = ifelse(hieng == 0, "low", "high"))
View(diet)
plot(bshazard(Surv((doe - dob)/scale, (dox - dob)/scale, chd) ~ 1,
data=subset(diet, hieng == "low")),
ylim=c(0,0.03), conf.int=FALSE, xlab="Attained age (years)")
lines(bshazard(Surv((doe - dob)/scale, (dox - dob)/scale, chd) ~ 1,
data=subset(diet, hieng == "high")),
col="red", conf.int=FALSE)
legend("topleft", legend=c('hieng=="low"','hieng=="high"'), col=1:2, lty=1, bty="n")
# Incidence rates by time since diagnosis
plot(muhaz2(Surv((dox - doe)/scale, chd) ~ hieng, data=diet), lty=2,
xlab="Time since study entry (years)", ylim=c(0,0.025),
legend=FALSE)
lines(bshazard(Surv((dox - doe)/scale, chd) ~ 1, data=subset(diet,hieng=="low")),
conf.int=FALSE)
plot(muhaz2(Surv((dox - doe)/scale, chd) ~ hieng, data=diet), lty=2,
xlab="Time since study entry (years)", ylim=c(0,0.025),
legend=FALSE)
plot(muhaz2(Surv((dox - doe)/scale, chd) ~ hieng, data=diet), lty=2,
xlab="Time since study entry (years)", ylim=c(0,0.025),
legend=FALSE)
legend("topleft", legend=c('hieng=="low"','hieng=="high"'), col=1:2, bty="n")
plot(muhaz2(Surv((dox - doe)/scale, chd) ~ hieng, data=diet), lty=2,
xlab="Time since study entry (years)", ylim=c(0,0.025),
legend=FALSE)
legend("topleft", legend=c('hieng=="low"','hieng=="high"'), col=1:2, lty=1, bty="n")
plot(muhaz2(Surv((dox - doe)/scale, chd) ~ hieng, data=diet),
xlab="Time since study entry (years)", ylim=c(0,0.025),
legend=FALSE)
legend("topleft", legend=c('hieng=="low"','hieng=="high"'), col=1:2, lty=1, bty="n")
plot(muhaz2(Surv((dox - doe)/scale, chd) ~ hieng, data=diet),
xlab="Time since study entry (years)", ylim=c(0,0.025),
legend=FALSE)
legend("topleft", legend=c('hieng=="low"','hieng=="high"'), col=1:2, lty=1, bty="n")
# Incidence rates by time since diagnosis
plot(muhaz2(Surv((dox - doe)/scale, chd) ~ hieng, data=diet),
xlab="Time since study entry (years)", ylim=c(0,0.025),
legend=FALSE)
legend("topleft", legend=c('hieng=="low"','hieng=="high"'), col=1:2, lty=1, bty="n")
plot(muhaz2(Surv((dox - doe)/scale, chd) ~ hieng, data=diet), lty=1,
xlab="Time since study entry (years)", ylim=c(0,0.025),
legend=FALSE)
legend("topleft", legend=c('hieng=="low"','hieng=="high"'), col=1:2, lty=1, bty="n")
##(b) Modelling the rate, no adjustment for timescale
poisson_b <- glm( chd ~ hieng + offset( log( y1k ) ),
family=poisson, data=diet)
summary(poisson_b)
summary(poisson_b)
diet <- mutate(diet, hieng = ifelse(hieng == 0, "low", "high"),
y1k = y / 1000)
poisson_b <- glm( chd ~ hieng + offset( log( y1k ) ),
family=poisson, data=diet)
summary(poisson_b)
summary(poisson_b)
poisson_b <- glm( chd ~ hieng + offset( log( y1k ) ),
family=poisson, data=diet)
diet <- mutate(diet, hieng = ifelse(hieng == 0, "low", "high"),
y1k = y / 1000)
View(diet)
poisson_b <- glm( chd ~ hieng + offset( log( y1k ) ),
family=poisson, data=diet)
class(diet$hieng)
class(diet$chd)
poisson_b <- glm( chd ~ hieng + offset( log( y1k ) ),
family=poisson, data=diet)
poisson_b <- glm( chd ~ hieng + offset( log( y1k ) ), family=poisson, data=diet)
diet$y1k <- diet$y/1000
poisson_b <- glm( chd ~ hieng + offset( log( y1k ) ), family=poisson, data=diet)
source('~/cansurv_r/solutions/q110.R', echo=TRUE)
library(biostat3)
library(haven)
library(dplyr) # manipulate data
library(bshazard)  # for nonparametric smoothing of hazard function
## Read data
diet <- read_dta("diet.dta")
#' hieng (energy intake) is coded as follows
#' 0 [low]
#' 1 [high]
diet <- mutate(diet, hieng = ifelse(hieng == 0, "low", "high"),
y1k = y / 1000)
poisson_b <- glm( chd ~ hieng + offset( log( y1k ) ), family=poisson, data=diet)
summary(poisson_b)
eform(poisson_b)
??glm
poisson_b <- glm( chd ~ hieng(hieng=="low") + offset( log( y1k ) ), family=poisson, data=diet)
diet <- mutate(diet, hieng = ifelse(hieng == 0, "low", "high"),
hieng = relevel(hieng, ref = "low"),
y1k = y / 1000)
??relevel
diet <- within(diet, hieng = relevel(hieng, ref = "low"))
diet <- within(diet, hieng = relevel(hieng, ref == "low"))
diet <- within(diet, hieng <- relevel(hieng, ref = "low"))
diet$hieng <- relevel(diet$hieng, ref = "low")
class(diet$hieng)
library(biostat3)
library(haven)
library(dplyr) # manipulate data
library(bshazard)  # for nonparametric smoothing of hazard function
## Read data
diet <- read_dta("diet.dta")
#' hieng (energy intake) is coded as follows
#' 0 [low]
#' 1 [high]
diet <- mutate(diet, hieng = ifelse(hieng == 1, "high", "low"),
y1k = y / 1000)
poisson_b <- glm( chd ~ hieng + offset( log( y1k ) ), family=poisson, data=diet)
summary(poisson_b)
eform(poisson_b)
diet$hieng <- relevel(diet$hieng, ref = "low")
poisson_b <- glm( chd ~ hieng + relevel(hieng, ref = "low") + offset( log( y1k ) ),
family=poisson, data=diet)
diet <- mutate(diet, hieng = as.factor(ifelse(hieng == 1, "high", "low")),
y1k = y / 1000)
poisson_b <- glm( chd ~ hieng + relevel(hieng, ref = "low") + offset( log( y1k ) ),
family=poisson, data=diet)
diet$hieng <- relevel(hieng, ref = "low")
diet$hieng <- relevel(diet$hieng, ref = "low")
poisson_b <- glm( chd ~ hieng + offset( log( y1k ) ),
family=poisson, data=diet)
## Exercise 112
## Created: 2021-03-22 Enoch Chen
## Edited:  2021-03-22 Enoch Chen
## Reference: Biostatistics III in R. https://biostat3.net/download/R/solutions/q8.html
###############################################################################
## Load the packages
library(biostat3)
library(haven)
library(dplyr) # manipulate data
library(bshazard)  # for nonparametric smoothing of hazard function
## Read data
diet <- read_dta("diet.dta")
#' hieng (energy intake) is coded as follows
#' 0 [low]
#' 1 [high]
diet <- mutate(diet, hieng = as.factor(ifelse(hieng == 1, "high", "low")),
y1k = y / 1000)
diet$hieng <- relevel(diet$hieng, ref = "low")
View(diet)
poisson_b <- glm( chd ~ hieng + offset( log( y1k ) ),
family=poisson, data=diet)
summary(poisson_b)
eform(poisson_b)
# Create BMI variable
diet$bmi <- diet$weight/((diet$height/100)^2)
# Create orderly varable instead of categorical, start at zero
levels(diet$job)
# Create BMI variable
diet$bmi <- diet$weight/((diet$height/100)^2)
# Create orderly varable instead of categorical, start at zero
levels(diet$job)
class(diet$job)
levels(diet$job)
poisson_c <- glm( chd ~ hieng + job + bmi + offset( log( y1k ) ),
family=poisson, data=diet)
summary(poisson_c)
eform(poisson_c)
source('~/cansurv_r/solutions/q112.R', echo=TRUE)
library(biostat3)
library(haven)
library(dplyr) # manipulate data
library(bshazard)  # for nonparametric smoothing of hazard function
## Read data
diet <- read_dta("diet.dta")
#' hieng (energy intake) is coded as follows
#' 0 [low]
#' 1 [high]
diet <- mutate(diet, hieng = as.factor(ifelse(hieng == 1, "high", "low")),
y1k = y / 1000)
## Check the loaded data
head(diet)
View(diet)
View(diet)
scale <- 365.24
age.cuts <- c(30,50,60,72)
diet.spl <- survSplit(Surv((doe - dob)/scale, (dox - dob)/scale, chd) ~ .,
data=diet, cut=age.cuts,start="tstart",end="tstop")
diet.spl %>% select(id, tstart, tstop, y) %>%
filter(id<=3) %>%
arrange(id, tstart)
View(diet.spl)
diet.spl %>% select(id, tstart, tstop, y) %>%
filter(row_number()==1:10) %>%
arrange(id, tstart)
diet.spl %>% select(id, tstart, tstop, y) %>%
slice(c(1,10)) %>%
arrange(id, tstart)
diet.spl %>% select(id, tstart, tstop, y) %>%
slice(c(1:10)) %>%
arrange(id, tstart)
scale <- 365.24
age.cuts <- c(30,50,60,72)
diet.spl <- survSplit(Surv((doe - dob)/scale, (dox - dob)/scale, chd) ~ .,
data=diet, cut=age.cuts,start="t0",end="t")
# Tabulate ageband
diet.spl %>% select(id, t0, t, y) %>%
slice(c(1:10)) %>%
arrange(id, tstart)
# Tabulate ageband
diet.spl %>% select(id, t0, t, y) %>%
slice(c(1:10)) %>%
arrange(id, t0)
scale <- 365.24
ageband <- c(30,50,60,72)
diet.spl <- survSplit(Surv((doe - dob)/scale, (dox - dob)/scale, chd) ~ .,
data=diet, cut=ageband,start="t0",end="t")
# Tabulate ageband
diet.spl %>% select(id, t0, t, ageband, y) %>%
slice(c(1:10)) %>%
arrange(id, t0)
scale <- 365.24
ageband <- c(30,50,60,72)
diet.spl <- survSplit(Surv((doe - dob)/scale, (dox - dob)/scale, chd) ~ .,
data=diet, cut=ageband, start="t0",end="t")
# Tabulate ageband
diet.spl %>% select(id, t0, t, ageband, y) %>%
slice(c(1:10)) %>%
arrange(id, t0)
View(diet.spl)
diet.spl <- survSplit(Surv((doe - dob)/scale, (dox - dob)/scale, chd) ~ .,
data=diet, cut=ageband, start="t0",end="t")
View(diet.spl)
diet.spl %>% select(id, t0, t, y) %>%
slice(c(1:10)) %>%
arrange(id, t0)
diet.spl$risktime <- diet.spl$t - diet.spl$t0
View(diet.spl)
diet.spl %>% select(id, t0, t, y, risktime) %>%
slice(c(1:10)) %>%
arrange(id, t0)
View(diet.spl)
diet.spl$agespan <- diet.spl%>%cut(t, ageband)
diet.spl$agespan <- diet.spl%>%cut(as.numeric(t), ageband)
diet.spl$agespan <- cut(diet.spl$t, diet.spl$ageband)
xtabs(~agespan+chd,diet.spl)
View(diet.spl)
View(diet.spl)
ageband
diet.spl$agespan <- cut(diet.spl$t, ageband)
xtabs(~agespan+chd,diet.spl)
poisson_d <- glm( chd ~ hieng + agespan + offset( log( risktime) ),
family=poisson,
data=diet.spl)
summary(poisson_d)
eform(poisson_d)
## Load the packages
library(biostat3)
library(haven)
library(dplyr) # manipulate data
library(bshazard)  # for nonparametric smoothing of hazard function
## Read data
diet <- read_dta("diet.dta")
#' hieng (energy intake) is coded as follows
#' 0 [low]
#' 1 [high]
diet <- mutate(diet, hieng = as.factor(ifelse(hieng == 1, "high", "low")),
y1k = y / 1000)
poisson_d <- glm( chd ~ hieng + agespan + offset( log( risktime) ),
family=poisson,
data=diet.spl)
summary(poisson_d)
eform(poisson_d)
diet.spl <- within(diet.spl, hieng <- relevel(hieng, ref = "low"))
poisson_d <- glm( chd ~ hieng + agespan + offset( log( risktime) ),
family=poisson,
data=diet.spl)
summary(poisson_d)
eform(poisson_d)
poisson_d2 <- glm( chd ~ hieng + agespan + job + bmi + offset( log( risktime) ),
family=poisson,
data=diet.spl)
source('~/cansurv_r/solutions/q112.R', echo=TRUE)
poisson_c <- glm( chd ~ hieng + job + bmi + offset( log( y1k ) ),
family=poisson, data=diet)
summary(poisson_c)
eform(poisson_c)
poisson_c <- glm( chd ~ hieng + as.factor(job) + bmi + offset( log( y1k ) ),
family=poisson, data=diet)
summary(poisson_c)
eform(poisson_c)
class(diet$job)
diet <- diet%>%mutate(bmi = weight/(height/100)^2,
job = as.factor(job))
poisson_c <- glm( chd ~ hieng + job + bmi + offset( log( y1k ) ),
family=poisson, data=diet)
summary(poisson_c)
eform(poisson_c)
poisson_d2 <- glm( chd ~ hieng + agespan + job + bmi + offset( log( risktime) ),
family=poisson,
data=diet.spl)
summary(poisson_d2)
eform(poisson_d2)
scale <- 365.24
ageband <- c(30,50,60,72)
diet.spl <- survSplit(Surv((doe - dob)/scale, (dox - dob)/scale, chd) ~ .,
data=diet, cut=ageband, start="t0",end="t")
# Tabulate ageband
diet.spl %>% select(id, t0, t, y) %>%
slice(c(1:10)) %>%
arrange(id, t0)
# Generate a risk time variable
diet.spl$risktime <- diet.spl$t - diet.spl$t0
# Tabulate ageband including risk_time
diet.spl %>% select(id, t0, t, y, risktime) %>%
slice(c(1:10)) %>%
arrange(id, t0)
# Tabulate ageband chd
diet.spl$agespan <- cut(diet.spl$t, ageband)
xtabs(~agespan+chd,diet.spl)
# Poisson regression adjusted for ageband
# Affirm that the reference group is hieng = low
diet.spl <- within(diet.spl, hieng <- relevel(hieng, ref = "low"))
poisson_d <- glm( chd ~ hieng + agespan + offset( log( risktime) ),
family=poisson,
data=diet.spl)
summary(poisson_d)
eform(poisson_d)
# Adjustment for confounders job, bmi
poisson_d2 <- glm( chd ~ hieng + agespan + job + bmi + offset( log( risktime) ),
family=poisson,
data=diet.spl)
summary(poisson_d2)
eform(poisson_d2)
##Tabulate ageband
diet.spl.t_entry %>% select(id, t0, t, y) %>%
slice(c(1:10)) %>%
arrange(id, t0)
##(e) Modelling the rate, adjusting for timescale time-in-study
fuband <- c(0, 5, 10, 15, 22)
diet.spl.t_entry <- survSplit(Surv((dox-doe)/365.24, chd) ~ .,
data=diet, cut=fuband, end="t", start="t0",
event="chd")
##Tabulate ageband
diet.spl.t_entry %>% select(id, t0, t, y) %>%
slice(c(1:10)) %>%
arrange(id, t0)
# Tabulate fuband chd
diet.spl.t_entry$fuspan <- cut(diet.spl.t_entry$t, fuband)
xtabs(~fuspan+chd,diet.spl.t_entry)
fuband <- c(0, 5, 10, 15, 22)
diet.spl.t_entry <- survSplit(Surv((dox-doe)/365.24, chd) ~ .,
data=diet, cut=fuband, end="t", start="t0",
event="chd")
##Tabulate fuband
diet.spl.t_entry %>% select(id, t0, t, y) %>%
slice(c(1:10)) %>%
arrange(id, t0)
#Tabulate fuband including risktime
diet.spl.t_entry$risktime <- diet.spl.t_entry$t - diet.spl.t_entry$t0
diet.spl.t_entry %>% select(id, t0, t, y, risktime) %>%
slice(c(1:10)) %>%
arrange(id, t0)
# Tabulate fuband chd
diet.spl.t_entry$fuspan <- cut(diet.spl.t_entry$t, fuband)
xtabs(~fuspan+chd,diet.spl.t_entry)
# Poisson regression adjusted for fuband
# Affirm that the reference group is hieng = low
diet.spl.t_entry <- within(diet.spl.t_entry, hieng <- relevel(hieng, ref = "low"))
poisson_e <- glm( chd ~ hieng + fuspan + offset( log( risktime) ),
family=poisson,
data=diet.spl.t_entry)
summary(poisson_e)
eform(poisson_e)
# Adjustment for confounders job, bmi
poisson_e2 <- glm( chd ~ hieng + agespan + job + bmi + offset( log( risktime) ),
family=poisson,
data=diet.spl.t_entry)
summary(poisson_e2)
eform(poisson_e2)
# Adjustment for confounders job, bmi
poisson_e2 <- glm( chd ~ hieng + fuspan + job + bmi + offset( log( risktime) ),
family=poisson,
data=diet.spl.t_entry)
summary(poisson_e2)
eform(poisson_e2)
source('~/cansurv_r/solutions/q112.R', echo=TRUE)
