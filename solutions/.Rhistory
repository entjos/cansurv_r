## Load the packages
library(biostat3)
library(haven)
library(dplyr)   # manipulate data
## Read data
## subset of stage 1
melanoma <- read_dta("melanoma.dta")%>%
filter(stage == 1)%>%
mutate(year8594 = ifelse(year8594 == 1, "Diagnosed 85-94", "Diagnosed 75-84"),
agegrp = as.factor(agegrp),
sex = as.factor(sex))
#' status is coded as follows
#' 1 [Dead: cancer]
#' 2 [Dead: other]
#' 0 [Alive]
#' 4 [Lost to follow-up]
#' agegrp is coded as follows
#' 1 [0-44]
#' 2 [45-59]
#' 3 [60-74]
#' 4 [75+]
#' sex is coded as follows
#' 1 [Male]
#' 2 [Female]
# Restrict follow-up to 10 years and create new variable for all-cause death
melanoma_10y <- mutate(melanoma,
status_all= ifelse(surv_mm <= 120 & status == 1 | 2, 1, 0),
surv_mm = ifelse(surv_mm<=120, surv_mm, 120), # censored everyone after 120 months
)
getwd()
setwd("~/cansurv_r/solutions")
library(biostat3)
library(haven)
library(dplyr)   # manipulate data
## Read data
## subset of stage 1
melanoma <- read_dta("melanoma.dta")%>%
filter(stage == 1)%>%
mutate(year8594 = ifelse(year8594 == 1, "Diagnosed 85-94", "Diagnosed 75-84"),
agegrp = as.factor(agegrp),
sex = as.factor(sex))
#' status is coded as follows
#' 1 [Dead: cancer]
#' 2 [Dead: other]
#' 0 [Alive]
#' 4 [Lost to follow-up]
#' agegrp is coded as follows
#' 1 [0-44]
#' 2 [45-59]
#' 3 [60-74]
#' 4 [75+]
#' sex is coded as follows
#' 1 [Male]
#' 2 [Female]
# Restrict follow-up to 10 years and create new variable for all-cause death
melanoma_10y <- mutate(melanoma,
status_all= ifelse(surv_mm <= 120 & status == 1 | 2, 1, 0),
surv_mm = ifelse(surv_mm<=120, surv_mm, 120), # censored everyone after 120 months
)
head(melanoma_10y)
head(melanoma_10y$, status, status_all)
head(melanoma_10y$status, melanoma_10y$status_all)
View(melanoma_10y)
melanoma_10y <- mutate(melanoma,
status_all= ifelse(surv_mm <= 120 & status == 1 | status == 2, 1, 0),
surv_mm = ifelse(surv_mm<=120, surv_mm, 120), # censored everyone after 120 months
)
View(melanoma_10y)
melanoma_10y <- mutate(melanoma,
status_all= ifelse(surv_mm <= 120 & (status == 1 | status == 2), 1, 0),
surv_mm = ifelse(surv_mm<=120, surv_mm, 120), # censored everyone after 120 months
)
View(melanoma_10y)
# Restrict follow-up to 10 years and create new variable for all-cause death
melanoma_10y <- mutate(melanoma,
status_all= ifelse(surv_mm <= 120 & (status == 1 | status == 2), 1, 0),
surv_mm = ifelse(surv_mm<=120, surv_mm, 120), # censored everyone after 120 months
)
cox_a <- coxph(Surv(surv_mm, status_all) ~ sex + year8594 + agegrp,
data = melanoma_10y)
summary(cox_a)
##(b) Cox regression with cause-specific death (cancer)
cox_b <- coxph(Surv(surv_mm, status_cancer) ~ sex + year8594 + agegrp,
data = melanoma_10y)
summary(cox_b)
melanoma_10y <- mutate(melanoma,
status_all= ifelse(surv_mm <= 120 & (status == 1 | status == 2), 1, 0),
status_cancer = ifelse(surv_mm <= 120 & status == 1 , 1, 0),
surv_mm = ifelse(surv_mm<=120, surv_mm, 120), # censored everyone after 120 months
)
cox_b <- coxph(Surv(surv_mm, status_cancer) ~ sex + year8594 + agegrp,
data = melanoma_10y)
summary(cox_b)
source('~/cansurv_r/solutions/q122.R', echo=TRUE)
cox_a <- coxph(Surv(surv_mm, death_cancer) ~ sex, data=melanoma)
summary(cox_a)
melanoma <- mutate(melanoma,
status_cancer = ifelse(surv_mm <= 120 & status == 1 , 1, 0),
)
##(a) Cox regression
cox_a <- coxph(Surv(surv_mm, death_cancer) ~ sex, data=melanoma)
summary(cox_a)
cox_a <- coxph(Surv(surv_mm, status_cancer) ~ sex, data=melanoma)
summary(cox_a)
library(biostat3)
library(haven)
library(dplyr)   # manipulate data
## Read data
## All stages
melanoma <- read_dta("melanoma.dta")%>%
mutate(year8594 = ifelse(year8594 == 1, "Diagnosed 85-94", "Diagnosed 75-84"),
agegrp = as.factor(agegrp),
sex = as.factor(sex))
#' status is coded as follows
#' 1 [Dead: cancer]
#' 2 [Dead: other]
#' 0 [Alive]
#' 4 [Lost to follow-up]
#' agegrp is coded as follows
#' 1 [0-44]
#' 2 [45-59]
#' 3 [60-74]
#' 4 [75+]
#' sex is coded as follows
#' 1 [Male]
#' 2 [Female]
# Create new variable for cause-specific death
melanoma <- mutate(melanoma,
status_cancer = ifelse(surv_mm <= 120 & status == 1 , 1, 0),
)
cox_a <- coxph(Surv(surv_mm, status_cancer) ~ sex, data=melanoma)
summary(cox_a)
melanoma <- read_dta("melanoma.dta")%>%
mutate(year8594 = ifelse(year8594 == 1, "Diagnosed 85-94", "Diagnosed 75-84"),
agegrp = as.factor(agegrp),
sex = as.factor(sex))
View(melanoma)
# Create new variable for cause-specific death
melanoma <- mutate(melanoma,
status_cancer = ifelse(status == 1 , 1, 0),
)
##(a) Cox regression
cox_a <- coxph(Surv(surv_mm, status_cancer) ~ sex, data=melanoma)
summary(cox_a)
cox_b <- coxph(Surv(surv_mm, status_cancer) ~ sex + agegrp + stage + subsite + year8594, data=melanoma.l)
summary(cox_b)
cox_b <- coxph(Surv(surv_mm, status_cancer) ~ sex + agegrp + stage + subsite + year8594, data=melanoma)
summary(cox_b)
##(b) Cox regression controlling for possible confounders
cox_b <- coxph(Surv(surv_mm, status_cancer) ~ sex + agegrp + stage + subsite + year8594, data=melanoma)
summary(cox_b)
melanoma <- read_dta("melanoma.dta")%>%
mutate(year8594 = ifelse(year8594 == 1, "Diagnosed 85-94", "Diagnosed 75-84"),
agegrp = as.factor(agegrp),
sex = as.factor(sex),
subsite = as.factor(subsite))
melanoma <- mutate(melanoma,
status_cancer = ifelse(status == 1 , 1, 0),
)
##(a) Cox regression
# Note:  R uses the Efron method for approximating the likelihood in the presence of ties.
# Stata uses the Breslow method.
cox_a <- coxph(Surv(surv_mm, status_cancer) ~ sex, data=melanoma)
summary(cox_a)
##(b) Cox regression controlling for possible confounders
cox_b <- coxph(Surv(surv_mm, status_cancer) ~ sex + agegrp + stage + subsite + year8594, data=melanoma)
summary(cox_b)
melanoma <- read_dta("melanoma.dta")%>%
mutate(year8594 = ifelse(year8594 == 1, "Diagnosed 85-94", "Diagnosed 75-84"),
agegrp = as.factor(agegrp),
sex = as.factor(sex),
stage = as.factor(stage),
subsite = as.factor(subsite))
#' status is coded as follows
#' 1 [Dead: cancer]
#' 2 [Dead: other]
#' 0 [Alive]
#' 4 [Lost to follow-up]
#' agegrp is coded as follows
#' 1 [0-44]
#' 2 [45-59]
#' 3 [60-74]
#' 4 [75+]
#' sex is coded as follows
#' 1 [Male]
#' 2 [Female]
#'
#' subsite is coded as follows
#' 1  [Head and Neck]
#' 2  [Trunk]
#' 3  [Limbs]
#' 4  [Multiple and NOS]
#'
#' stage is coded as follows
#' 0  [Unknown]
#' 1  [Localised]
#' 2  [Regional]
#' 3  [Distant]
# Create new variable for cause-specific death
melanoma <- mutate(melanoma,
status_cancer = ifelse(status == 1 , 1, 0),
)
##(a) Cox regression
# Note:  R uses the Efron method for approximating the likelihood in the presence of ties.
# Stata uses the Breslow method.
cox_a <- coxph(Surv(surv_mm, status_cancer) ~ sex, data=melanoma)
summary(cox_a)
##(b) Cox regression controlling for possible confounders
cox_b <- coxph(Surv(surv_mm, status_cancer) ~ sex + agegrp + stage + subsite + year8594, data=melanoma)
summary(cox_b)
cox_c <- coxph(Surv(surv_mm, status_cancer) ~ agegrp + agegrp * sex, data=melanoma.l)
summary(cox_c)
##(c) Cox regression with interactions
cox_c <- coxph(Surv(surv_mm, status_cancer) ~ agegrp + agegrp * sex, data=melanoma)
summary(cox_c)
cox_c <- coxph(Surv(surv_mm, status_cancer) ~ agegrp + sex * agegrp, data=melanoma)
summary(cox_c)
cox_c <- coxph(Surv(surv_mm, status_cancer) ~ agegrp + sex * agegrp, data=melanoma)
summary(cox_c)
##(c) Cox regression with interactions
cox_c <- coxph(Surv(surv_mm, status_cancer) ~ sex * agegrp, data=melanoma)
summary(cox_c)
cox_d <- coxph(Surv(surv_mm, status_cancer) ~ sex * agegrp, data=melanoma)
summary(cox_d)
cox_c <- coxph(Surv(surv_mm, status_cancer) ~ sex * agegrp, data=melanoma)
summary(cox_c)
##(c) Cox regression with interactions
cox_c <- coxph(Surv(surv_mm, status_cancer) ~ sex * agegrp, data=melanoma)
summary(cox_c)
cox.zph(cox_c, transform="log")
cox.zph(cox_c, transform="identity")
cox.zph(cox_c)
cox.zph(cox_c, transform="log")
anova(cox_c)
cox_d <- coxph(Surv(surv_mm, status_cancer) ~ sex + year8594 + agegrp + subsite + stage, data=melanoma)
summary(cox_d)
cox.zph(cox_d, transform="identity") # Stata default
cox_c2 <- coxph(Surv(surv_mm, status_cancer) ~ year8594 + subsite + stage + sex * agegrp, data=melanoma)
summary(cox_c2)
cox.zph(cox_c2, transform="identity") # Stata default
cox.zph(cox_c2, transform="log") # Stata default
anova(cox_c2)
cox.zph(cox_c, transform="identity") # Stata default
cox.zph(cox_c2, transform="identity") # Stata default
cox_strat <- coxph(Surv(surv_mm, status_cancer) ~ sex + year8594 + agegrp + subsite + strata(stage), data=melanoma)
summary(cox_strat)
cox.zph(cox_strat, transform="identity") # Stata default
cox_strat2 <- coxph(Surv(surv_mm, status_cancer) ~ sex + year8594 + agegrp  + strata(stage), data=melanoma)
summary(cox_strat2)
cox.zph(cox_strat2, transform="identity")
cox_strat3 <- coxph(Surv(surv_mm, status_cancer) ~ sex * agegrp + year8594 + agegrp + subsite + strata(stage), data=melanoma)
summary(cox_strat3)
anova(cox_strat3)
source('~/cansurv_r/solutions/q123.R', echo=TRUE)
